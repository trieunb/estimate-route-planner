function classesSelect(){return{require:"ngModel",restrict:"E",scope:{ngModel:"=",selectOptions:"=options",ngDisabled:"=",ngRequired:"&"},template:'<selectize ng-model="ngModel" config="selectConfig" options="selectOptions"></selectize>',controller:["$scope",function($scope){$scope.selectConfig={valueField:"id",labelField:"name",searchField:"name",sortField:"name",selectOnTab:!0,maxItems:1,maxOptions:300}}]}}function customerSignatureModal($rootScope,$timeout){return{restrict:"E",scope:{isShowModal:"=show",onSave:"&"},replace:!0,templateUrl:$rootScope.templatesPath+"estimate/modal-signature.html",link:function(scope,element,attrs,ctrl){scope.isShowModal=!1,$timeout(function(){var padWrapper=angular.element(".div-customer-signature"),canvas=padWrapper.find("canvas").get(0);scope.signaturePad=new SignaturePad(canvas)})},controller:function($scope){$scope.hideModal=function(){$scope.isShowModal=!1,$scope.clear()},$scope.clear=function(){$scope.signaturePad.clear()},$scope.save=function(){$scope.isShowModal=!1;var encoded;encoded=$scope.signaturePad.isEmpty()?null:$scope.signaturePad.toDataURL(),$scope.onSave({signatureEncoded:encoded}),$scope.clear()}}}}function customerTypeahead(){return{scope:{ngModel:"=",placeholder:"@",onSelect:"&"},controller:["$scope","erpLocalStorage",function($scope,erpLocalStorage){$scope.customers=[],erpLocalStorage.getCustomers().then(function(data){$scope.customers=data}),$scope.typeaheadOnSelect=function($item,$model,$label){$scope.onSelect({item:$item})}}],restrict:"E",template:'<input class="form-control" typeahead-focus-first="false" typeahead-on-select="typeaheadOnSelect($item, $model, $label)" ng-model="ngModel" placeholder="{{placeholder}}" uib-typeahead="customer.display_name as customer.display_name for customer in ::customers | filter:$viewValue | limitTo:30" typeahead-wait-ms="200" placeholder="Search by customer name, number ... ">'}}function estimatorsSelect(){return{require:"ngModel",restrict:"E",scope:{ngModel:"=",selectOptions:"=options",ngDisabled:"=",ngRequired:"&"},template:'<selectize ng-model="ngModel" config="selectConfig" options="selectOptions"></selectize>',controller:["$scope",function($scope){$scope.selectConfig={valueField:"id",labelField:"name",searchField:"name",sortField:"name",selectOnTab:!0,maxItems:1,maxOptions:300}}]}}function textTruncate(){return{restrict:"E",scope:{text:"=text",limit:"=limit"},template:'<p>{{::displayText}} <span title="More" ng-if="text.length > 0" class="btn-show-truncated-details" ng-click="showDetail()">{{endBy}}</span> <p>',link:function(scope,el,attrs,ngModel){var DEFAULT_END_BY=" ...?",DEFAULT_LIMIT=20,truncate=function(text,limit,endBy){return text.length<=limit?text:String(text).substring(0,limit-endBy.length)};null===scope.text&&(scope.text=""),scope.limit<=0&&(scope.limit=DEFAULT_LIMIT),scope.displayText="",scope.displayText=truncate(scope.text,scope.limit,DEFAULT_END_BY),scope.endBy=DEFAULT_END_BY},controller:["$scope","$ngBootbox",function($scope,$ngBootbox){function htmlEntities(str){return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}$scope.showDetail=function(){$ngBootbox.alert(htmlEntities($scope.text))}}]}}function classFactory($http){return{all:function(){return $http.get(ERPApp.baseAPIPath,{params:{_do:"getClasses"}})}}}function dataFactory($http){return{getSharedData:function(){return $http.get(ERPApp.baseAPIPath,{params:{_do:"getSharedData"}})}}}function erpLocalStorage($q,sharedData,employeeFactory,customerFactory,productServiceFactory,classFactory){var _this=this,cacheData={productServices:null,employees:null,customers:null,unsortCustomers:null,classes:null},init=function(){},rememberData=function(key,value){cacheData[key]=value},buildCustomersTree=function(customers,parentId){for(var result=[],length=customers.length,i=0;length>i;i++){var item=customers[i];item.parent_id===parentId&&(item.childs=buildCustomersTree(customers,item.id),result.push(item))}return result.length>0?result:null},flatternCustomer=function(customer){var results=[];if(results[0]=customer,null!==customer.childs&&customer.childs.length>0){var childs=customer.childs;childs.sort(function(a,b){return a.display_name.localeCompare(b.display_name)});for(var i=0;i<customer.childs.length;i++)results=results.concat(flatternCustomer(customer.childs[i]))}return results},sortCustomers=function(customers){for(var tree=buildCustomersTree(customers,null),results=[],treeLen=tree.length,i=0;treeLen>i;i++)results=results.concat(flatternCustomer(tree[i]));for(var j=(results.length,results.length-1);j>=0;j--)results[j].order=j;return results};this.clearCustomers=function(){cacheData.customers=null},this.clearProductServices=function(){cacheData.productServices=null},this.clearClasses=function(){cacheData.classes=null},this.clearEmployees=function(){cacheData.employees=null},this.addCustomer=function(customer){cacheData.unsortCustomers&&(cacheData.unsortCustomers.push(customer),_this.setCustomers(cacheData.unsortCustomers))},this.updateCustomer=function(customer){if(cacheData.unsortCustomers)for(var i=0;i<cacheData.unsortCustomers.length;i++)if(cacheData.unsortCustomers[i].id==customer.id){cacheData.unsortCustomers[i]={},cacheData.unsortCustomers[i]=customer,_this.setCustomers(cacheData.unsortCustomers);break}},this.setCustomers=function(customers){rememberData("unsortCustomers",customers);var sortedCustomers=[];customers.length&&(sortedCustomers=sortCustomers(customers)),rememberData("customers",sortedCustomers)},this.getCustomers=function(){return $q(function(resolve){null===cacheData.customers?customerFactory.all().success(function(responseData){_this.setCustomers(responseData),resolve(cacheData.customers)}):resolve(cacheData.customers)})},this.getProductServices=function(){return $q(function(resolve){null===cacheData.productServices?productServiceFactory.all().success(function(responseData){rememberData("productServices",responseData),resolve(cacheData.productServices)}):resolve(cacheData.productServices)})},this.getClasses=function(){return $q(function(resolve){null===cacheData.classes?classFactory.all().success(function(responseData){rememberData("classes",responseData),resolve(cacheData.classes)}):resolve(cacheData.classes)})},this.getEmployees=function(){return $q(function(resolve){null===cacheData.employees?employeeFactory.all().success(function(responseData){rememberData("employees",responseData),resolve(responseData)}):resolve(cacheData.employees)})},init()}function erpGeoLocation($q){var geocoder=new google.maps.Geocoder;this.resolve=function(address){return $q(function(success,fails){geocoder.geocode({address:address},function(results,status){status==google.maps.GeocoderStatus.OK&&results.length>0?success(results[0].geometry.location):fails()})})}}function userPermission(USER_CAPABILITIES){var currentUserCaps={};angular.copy(USER_CAPABILITIES,currentUserCaps);var capsToPaths={erpp_access:"^/$",erpp_create_estimates:"^/new-estimate$",erpp_edit_estimates:"^/edit-estimate/\\d+$",erpp_list_estimates:"^/estimates$",erpp_create_job_requests:"^/new-job-request$",erpp_edit_job_requests:"^/edit-job-request/\\d+$",erpp_list_job_requests:"^/job-requests$",erpp_create_estimate_routes:"^/new-estimate-route$",erpp_edit_estimate_routes:"^/edit-estimate-route/\\d+$",erpp_list_estimate_routes:"^/estimate-routes$",erpp_create_crew_routes:"^/new-crew-route$",erpp_edit_crew_routes:"^/edit-crew-route/\\d+$",erpp_list_crew_routes:"^/crew-routes$",erpp_settings:"^/settings$",erpp_settings:"^/company-info$",erpp_settings:"^/quickbooks-sync$"};this.capForPath=function(requestPath){for(var cap in capsToPaths){var rge=new RegExp(capsToPaths[cap]);if(rge.test(requestPath))return cap}},this.hasCap=function(cap){return currentUserCaps[cap]===!0},this.canAccessTo=function(path){var cap=this.capForPath(path);return"undefined"!=typeof cap?this.hasCap(cap):!0}}function CompanyInfoCtrl($scope,$rootScope,companyInfoFactory,sharedData){$scope.setPageTitle("Company Info"),$scope.info={},companyInfoFactory.get().success(function(response){$scope.info=response}),$scope.submitForm=function(){companyInfoFactory.save($scope.info).success(function(response){if(response.success)toastr.success(response.message),sharedData.companyInfo=response.data;else{var msg=response.message||"An error occurred while saving info";toastr.error(msg)}})},$scope.imageChange=function(element){var photofile=element.files[0];if("undefined"!=typeof photofile){$scope.photofile=photofile;var reader=new FileReader;reader.onload=function(e){angular.element("#logo_upload_img").attr("src",e.target.result)},reader.readAsDataURL(photofile)}else $scope.photofile=null},$scope.uploadLogo=function(){null!==$scope.photofile&&companyInfoFactory.uploadLogo($scope.photofile).success(function(response){if(response.success)$scope.photofile=null,toastr.success(response.message),angular.element("#logo-form").get(0).reset(),sharedData.companyInfo=response.data;else{var msg=response.message||"An error occurred while uploading logo";toastr.error(msg)}})}}function companyInfoFactory($http){return{save:function(info){return $http.post(ERPApp.baseAPIPath,{_do:"updateCompanyInfo",data:info})},get:function(){return $http.get(ERPApp.baseAPIPath,{params:{_do:"getCompanyInfo"}})},uploadLogo:function(photoFile){var fd=new FormData;return fd.append("file",photoFile),fd.append("_do","uploadLogo"),$http.post(ERPApp.baseAPIPath,fd,{withCredentials:!0,transformRequest:angular.identity,headers:{"Content-Type":void 0}})}}}function customerFactory($http){return{all:function(){return $http.get(ERPApp.baseAPIPath,{params:{_do:"getCustomers"}})},create:function(data){return $http.post(ERPApp.baseAPIPath,{_do:"createCustomer",data:data})},show:function(id){return $http.post(ERPApp.baseAPIPath,{_do:"showCustomer",data:{id:id}})},update:function(data){return $http.post(ERPApp.baseAPIPath,{_do:"updateCustomer",data:data})}}}function employeeFactory($http){return{all:function(){return $http.get(ERPApp.baseAPIPath,{params:{_do:"getEmployees"}})}}}function AddEstimateCtrl($scope,$rootScope,$http,$timeout,$routeParams,$filter,$location,estimateFactory,jobRequestFactory,erpGeoLocation,$ngBootbox,sharedData,erpLocalStorage,erpOptions){$scope.setPageTitle("New estimate"),$scope.customers=[],$scope.jobCustomers=[],$scope.employees=[],$scope.estimate={},$scope.estimate.lines=[],$scope.estimate.total=0,$scope.companyInfo={},$scope.productServices=[],$scope.classes=[],angular.copy(sharedData.companyInfo,$scope.companyInfo),$scope.estimate.estimate_footer=$scope.companyInfo.estimate_footer,$scope.estimate.disclaimer=$scope.companyInfo.disclaimer,$scope.estimate.sold_by_1=sharedData.currentUserName,$scope.isShowModalSignature=!1,$scope.estimateStatuses=erpOptions.estimateStatuses,$scope.estimate.txn_date=$filter("date")(new Date,"yyyy-MM-dd"),$scope.estimate.expiration_date=$filter("date")((new Date).getTime()+2592e6,"yyyy-MM-dd"),erpLocalStorage.getProductServices().then(function(data){angular.forEach(data,function(service){1==service.active&&$scope.productServices.push(service)})}),$scope.soldBySelectConfig={valueField:"name",labelField:"name",searchField:"name",maxItems:1},$scope.productServicesSelectConfig={valueField:"id",labelField:"name",searchField:"name",maxItems:1},erpLocalStorage.getCustomers().then(function(data){$scope.customers=[],$scope.jobCustomers=[],angular.copy(data,$scope.customers),angular.copy(data,$scope.jobCustomers)}),erpLocalStorage.getEmployees().then(function(data){$scope.employees=[],angular.copy(data,$scope.employees)}),erpLocalStorage.getClasses().then(function(data){$scope.classes=[],angular.copy(data,$scope.classes)});var isTheSameCustomer=function(){return $scope.estimate.customer_id==$scope.estimate.job_customer_id};$scope.onBillCustomerCreated=function(){erpLocalStorage.getCustomers().then(function(data){$scope.jobCustomers=[],angular.copy(data,$scope.jobCustomers)})},$scope.onBillCustomerUpdate=function(){resetBillCustomer(),erpLocalStorage.getCustomers().then(function(data){$scope.jobCustomers=[],angular.copy(data,$scope.jobCustomers)}),isTheSameCustomer()&&resetJobCustomer()},$scope.onBillCustomerChange=function(){resetBillCustomer()},$scope.onJobCustomerCreated=function(){erpLocalStorage.getCustomers().then(function(data){$scope.customers=[],angular.copy(data,$scope.customers)})},$scope.onJobCustomerUpdate=function(){resetJobCustomer(),erpLocalStorage.getCustomers().then(function(data){$scope.customers=[],angular.copy(data,$scope.customers)}),isTheSameCustomer()&&resetBillCustomer()},$scope.onJobCustomerChange=function(){resetJobCustomer()};var resetBillCustomer=function(){"undefined"!=typeof $scope.estimate.customer_id&&erpLocalStorage.getCustomers().then(function(customers){for(var i=0;i<customers.length;i++)if(customers[i].id==$scope.estimate.customer_id){var cus=customers[i];$scope.estimate.bill_address=cus.bill_address,$scope.estimate.bill_city=cus.bill_city,$scope.estimate.bill_state=cus.bill_state,$scope.estimate.bill_zip_code=cus.bill_zip_code,$scope.estimate.bill_country=cus.bill_country,$scope.estimate.primary_phone_number=cus.primary_phone_number,$scope.estimate.mobile_phone_number=cus.mobile_phone_number,$scope.estimate.email=cus.email;break}})},resetJobCustomer=function(){"undefined"!=typeof $scope.estimate.job_customer_id&&erpLocalStorage.getCustomers().then(function(customers){for(var i=0;i<customers.length;i++)if(customers[i].id==$scope.estimate.job_customer_id){var cus=customers[i];$scope.estimate.job_address=cus.ship_address,$scope.estimate.job_city=cus.ship_city,$scope.estimate.job_state=cus.ship_state,$scope.estimate.job_zip_code=cus.ship_zip_code,$scope.estimate.job_country=cus.ship_country;break}})};$scope.lineItemsDragListeners={accept:function(sourceItemHandleScope,destSortableScope){return!0},itemMoved:function(event){},orderChanged:function(event){$scope.reorderLineNum()}},$scope.addLine=function(){$scope.estimate.lines.push({product_service_id:null,line_id:null,qty:null,rate:null,total:null}),$scope.updateTotal()},$scope.removeLine=function(line){$scope.estimate.lines.splice($scope.estimate.lines.indexOf(line),1),$scope.reorderLineNum(),$scope.updateTotal()},$scope.removeAllLines=function(){$ngBootbox.confirm("Are you sure want to remove all the lines?").then(function(){$scope.estimate.lines=[],$scope.updateTotal()})},$scope.changeLineProductService=function(line){angular.forEach($scope.productServices,function(pd){return line.product_service_id==pd.id?(line.description=pd.description,line.rate=parseFloat(pd.rate),void(line.qty||(line.qty=1))):void 0}),$scope.updateTotal()},$scope.reorderLineNum=function(){angular.forEach($scope.estimate.lines,function(line){line.line_num=$scope.estimate.lines.indexOf(line)+1})},$scope.updateTotal=function(){var total=0;$scope.estimate.lines.length>0&&angular.forEach($scope.estimate.lines,function(line){var rate=0,qty=0;if(line.qty&&(qty=parseInt(line.qty)),line.rate&&(rate=parseFloat(line.rate)),line.product_service_id){var lineTotal=rate*qty;line.total=lineTotal,total+=lineTotal}}),$scope.estimate.total=parseFloat(total.toFixed(2))};var isEmptyLines=function(){return 0===$scope.estimate.lines.length};$scope.submitForm=function(){isEmptyLines()?toastr.error("You must fill out at least one split line."):erpGeoLocation.resolve(getJobFullAddress()).then(function(result){$scope.estimate.job_lat=result.lat(),$scope.estimate.job_lng=result.lng();var estimate={};angular.copy($scope.estimate,estimate),estimate.txn_date&&(estimate.txn_date=$filter("date")(estimate.txn_date,"yyyy-MM-dd")),estimate.expiration_date&&(estimate.expiration_date=$filter("date")(estimate.expiration_date,"yyyy-MM-dd")),estimate.date_of_signature&&(estimate.date_of_signature=$filter("date")(estimate.date_of_signature,"yyyy-MM-dd")),$scope.signatureEncoded&&(estimate.customer_signature_encoded=$scope.signatureEncoded),estimateFactory.save(estimate).success(function(response){if(response.success)toastr.success(response.message),$location.path("/edit-estimate/"+response.data.id);else{var msg=response.message||"An error occurred while saving estimate";toastr.error(msg)}}).error(function(){toastr.error("An error occurred while saving estimate")})},function(){toastr.error("Could not find geo location of job address!")})},$scope.showSignatureBox=function(){$scope.isShowModalSignature=!0},$scope.onSaveSignature=function(signature){$scope.signatureEncoded=signature};var getJobFullAddress=function(){return $scope.estimate.job_address+" "+$scope.estimate.job_city+" "+$scope.estimate.job_state+" "+$scope.estimate.job_zip_code};$timeout(function(){var jobRequestId=$routeParams.ref;"undefined"!=typeof jobRequestId&&jobRequestFactory.show(jobRequestId).success(function(jobRequestData){$scope.estimate.customer_id=jobRequestData.customer_id,$scope.estimate.job_customer_id=jobRequestData.customer_id,resetBillCustomer(),$timeout(function(){if($scope.estimate.job_address=jobRequestData.address,$scope.estimate.job_city=jobRequestData.city,$scope.estimate.job_state=jobRequestData.state,$scope.estimate.job_zip_code=jobRequestData.zip_code,$scope.estimate.job_country=jobRequestData.country,$scope.estimate.email=jobRequestData.email,$scope.estimate.mobile_phone_number=jobRequestData.mobile_phone_number,$scope.estimate.primary_phone_number=jobRequestData.primary_phone_number,$scope.estimate.class_id=jobRequestData.class_id,jobRequestData.estimator_id)for(var i=0;i<$scope.employees.length;i++)if($scope.employees[i].id==jobRequestData.estimator_id){$scope.estimate.sold_by_1=$scope.employees[i].name;break}},300)})},200)}function EditEstimateCtrl($scope,$rootScope,$http,$routeParams,$filter,$location,estimateFactory,erpLocalStorage,erpGeoLocation,attachmentUploader,sharedData,erpOptions,$ngBootbox,$window){$scope.setPageTitle("Estimate"),$scope.customers=[],$scope.jobCustomers=[],$scope.employees=[],$scope.estimate={},$scope.uploadProgress=0,$scope.isChangedSignature=!1,$scope.companyInfo={},$scope.productServices=[],$scope.classes=[],angular.copy(sharedData.companyInfo,$scope.companyInfo),$scope.isShowModalSignature=!1,$scope.estimateStatuses=erpOptions.estimateStatuses,$scope.soldBySelectConfig={valueField:"name",labelField:"name",searchField:"name",maxItems:1},$scope.productServicesSelectConfig={valueField:"id",labelField:"name",searchField:"name",maxItems:1},erpLocalStorage.getProductServices().then(function(data){angular.forEach(data,function(service){1==service.active&&$scope.productServices.push(service)})}),erpLocalStorage.getEmployees().then(function(data){$scope.employees=[],angular.copy(data,$scope.employees)}),erpLocalStorage.getClasses().then(function(data){$scope.classes=[],angular.copy(data,$scope.classes)}),estimateFactory.show($routeParams.id).success(function(response){var estimate=response;estimate.doc_number?$rootScope.pageTitle="Estimate #"+estimate.doc_number:$rootScope.pageTitle="Edit estimate";var lineProductServiceIds=[];angular.forEach(estimate.lines,function(line){null===line.line_num?line.line_num=estimate.lines.length:line.line_num=parseInt(line.line_num),null!==line.rate&&(line.rate=parseFloat(line.rate)),null!==line.qty&&(line.qty=parseInt(line.qty));var lineTotal=line.qty*line.rate;line.product_service_id&&(line.total=parseFloat(lineTotal.toFixed(2)),lineProductServiceIds.push(line.product_service_id))}),erpLocalStorage.getProductServices().then(function(data){angular.forEach(data,function(pd){(1==pd.active||-1!==lineProductServiceIds.indexOf(pd.id))&&$scope.productServices.push(pd)})}),estimate.lines=$filter("orderBy")(estimate.lines,"line_num",!1),estimate.customer_signature&&($scope.signatureEncoded=$rootScope.baseERPPluginUrl+estimate.customer_signature),$scope.estimate=estimate,$scope.updateTotal(),erpLocalStorage.getCustomers().then(function(data){$scope.customers=[],$scope.jobCustomers=[],angular.copy(data,$scope.customers),"0"===$scope.estimate.customer_active&&$scope.customers.push({id:$scope.estimate.customer_id,display_name:$scope.estimate.customer_display_name,order:$scope.customers.length}),angular.copy(data,$scope.jobCustomers),"0"===$scope.estimate.job_customer_active&&$scope.jobCustomers.push({id:$scope.estimate.job_customer_id,display_name:$scope.estimate.job_customer_display_name,order:$scope.jobCustomers.length})})}),$scope.dropzoneConfig={url:"fake",clickable:".drop-clickable",parallelUploads:1,uploadMultiple:!1,maxFileSize:30,paramName:"file",maxFilesize:5,accept:function(file,done){$scope.isUploading=!0,$scope.$apply(),done()},success:function(file,response){response.success&&($scope.estimate.attachments.push(response.attachment),$scope.$apply())},previewTemplate:angular.element("#dropzone-preview-template").html(),previewsContainer:"#attachment-previews",complete:function(file){$scope.isUploading=!1,$scope.$apply()},uploadprogress:function(file,progress,bytesSent){$scope.uploadProgress=progress.toFixed(0),$scope.$apply()},init:function(){this.on("processing",function(file){this.options.url=ERPApp.baseAPIPath+"&_do=uploadAttachment&data[id]="+$scope.estimate.id})}},$scope.removeAttachment=function(attachment){$ngBootbox.confirm("Are you sure want to remove the attachment?").then(function(){attachmentUploader.destroy(attachment.id).success(function(response){$scope.estimate.attachments.splice($scope.estimate.attachments.indexOf(attachment),1),toastr.success(response.message)}).error(function(){toastr.error("An error has occurred while deleting attachment")})},function(){})},$scope.lineItemsDragListeners={accept:function(sourceItemHandleScope,destSortableScope){return!0},itemMoved:function(event){},orderChanged:function(event){$scope.reorderLineNum()}},$scope.addLine=function(){$scope.estimate.lines.push({product_service_id:null,line_id:null,qty:null,rate:null,total:null}),$scope.updateTotal()},$scope.removeLine=function(line){$scope.estimate.lines.splice($scope.estimate.lines.indexOf(line),1),$scope.reorderLineNum(),$scope.updateTotal()},$scope.removeAllLines=function(){$ngBootbox.confirm("Are you sure want to remove all the lines?").then(function(){$scope.estimate.lines=[],$scope.updateTotal()})},$scope.changeLineProductService=function(line){angular.forEach($scope.productServices,function(pd){return line.product_service_id==pd.id?(line.description=pd.description,line.rate=parseFloat(pd.rate),void(line.qty||(line.qty=1))):void 0}),$scope.updateTotal()},$scope.reorderLineNum=function(){angular.forEach($scope.estimate.lines,function(line){line.line_num=$scope.estimate.lines.indexOf(line)+1})};var isTheSameCustomer=function(){return $scope.estimate.customer_id==$scope.estimate.job_customer_id};$scope.onBillCustomerCreated=function(){erpLocalStorage.getCustomers().then(function(data){$scope.jobCustomers=[],angular.copy(data,$scope.jobCustomers)})},$scope.onBillCustomerUpdate=function(){resetBillCustomer(),erpLocalStorage.getCustomers().then(function(data){$scope.jobCustomers=[],angular.copy(data,$scope.jobCustomers)}),isTheSameCustomer()&&resetJobCustomer()},$scope.onBillCustomerChange=function(){resetBillCustomer()},$scope.onJobCustomerCreated=function(){erpLocalStorage.getCustomers().then(function(data){$scope.customers=[],angular.copy(data,$scope.customers)})},$scope.onJobCustomerUpdate=function(){resetJobCustomer(),erpLocalStorage.getCustomers().then(function(data){$scope.customers=[],angular.copy(data,$scope.customers)}),isTheSameCustomer()&&resetBillCustomer()},$scope.onJobCustomerChange=function(){resetJobCustomer()};var resetBillCustomer=function(){"undefined"!=typeof $scope.estimate.customer_id&&erpLocalStorage.getCustomers().then(function(customers){for(var i=0;i<customers.length;i++)if(customers[i].id==$scope.estimate.customer_id){var cus=customers[i];$scope.estimate.bill_address=cus.bill_address,$scope.estimate.bill_city=cus.bill_city,$scope.estimate.bill_state=cus.bill_state,$scope.estimate.bill_zip_code=cus.bill_zip_code,$scope.estimate.bill_country=cus.bill_country,$scope.estimate.primary_phone_number=cus.primary_phone_number,$scope.estimate.mobile_phone_number=cus.mobile_phone_number,$scope.estimate.email=cus.email;break}})},resetJobCustomer=function(){"undefined"!=typeof $scope.estimate.job_customer_id&&erpLocalStorage.getCustomers().then(function(customers){for(var i=0;i<customers.length;i++)if(customers[i].id==$scope.estimate.job_customer_id){var cus=customers[i];$scope.estimate.job_address=cus.ship_address,$scope.estimate.job_city=cus.ship_city,$scope.estimate.job_state=cus.ship_state,$scope.estimate.job_zip_code=cus.ship_zip_code,$scope.estimate.job_country=cus.ship_country;break}})};$scope.updateTotal=function(){var total=0;$scope.estimate.lines.length>0&&angular.forEach($scope.estimate.lines,function(line){var rate=0,qty=0;if(line.qty&&(qty=parseInt(line.qty)),line.rate&&(rate=parseFloat(line.rate)),line.product_service_id){var lineTotal=rate*qty;line.total=lineTotal,total+=lineTotal}}),$scope.estimate.total=parseFloat(total.toFixed(2))};var isEmptyLines=function(){return 0===$scope.estimate.lines.length};$scope.sendMailEstimate=function(){$scope.showSendModal=!1,estimateFactory.sendMail($scope.sendMailData).success(function(response){response.success?toastr.success(response.message):toastr.error(response.message)})},$scope.submitForm=function(sendMail){isEmptyLines()?toastr.error("You must fill out at least one split line."):erpGeoLocation.resolve(getJobFullAddress()).then(function(result){$scope.estimate.job_lat=result.lat(),$scope.estimate.job_lng=result.lng();var estimate={};angular.copy($scope.estimate,estimate),delete estimate.attachments,estimate.txn_date&&(estimate.txn_date=$filter("date")(estimate.txn_date,"yyyy-MM-dd")),estimate.expiration_date&&(estimate.expiration_date=$filter("date")(estimate.expiration_date,"yyyy-MM-dd")),estimate.date_of_signature&&(estimate.date_of_signature=$filter("date")(estimate.date_of_signature,"yyyy-MM-dd")),$scope.isChangedSignature&&(estimate.customer_signature_encoded=$scope.signatureEncoded),estimateFactory.update(estimate).success(function(response){if(response.success)$scope.isChangedSignature&&!$scope.estimate.customer_signature&&($scope.estimate.status="Accepted"),$scope.isChangedSignature=!1,toastr.success(response.message),sendMail&&($scope.sendMailData={id:$scope.estimate.id,to:$scope.estimate.email,subject:"Estimate from "+$scope.companyInfo.name},$scope.sendMailForm.$setPristine(),$scope.showSendModal=!0);else{var msg=response.message||"An error occurred while saving estimate";toastr.error(msg)}}).error(function(){toastr.error("An error occurred while updating estimate")})},function(){toastr.error("Could not find geo location of job address!")})},$scope.showSignatureBox=function(){$scope.isShowModalSignature=!0},$scope.onSaveSignature=function(signature){$scope.signatureEncoded=signature,$scope.isChangedSignature=!0};var getJobFullAddress=function(){return $scope.estimate.job_address+" "+$scope.estimate.job_city+" "+$scope.estimate.job_state+" "+$scope.estimate.job_zip_code}}function ListEstimateCtrl($scope,$rootScope,$routeParams,$location,$timeout,estimateFactory,sharedData,erpLocalStorage,erpGeoLocation){$scope.setPageTitle("Estimates List"),$scope.estimates={},$scope.selectedStatus="",$scope.sendMailData={},$scope.filter={keyword:"",status:""},$scope.total=0;var currentPage=1;"undefined"!=typeof $routeParams.pageNumber&&(currentPage=$routeParams.pageNumber),$scope.currentPage=currentPage,$scope.customers=[],$scope.isCheckingGeoLocation=!1;var paginate=function(){var query={_do:"getEstimates",page:$scope.currentPage,status:$scope.filter.status,keyword:$scope.filter.keyword};estimateFactory.list(query).success(function(response){$scope.estimates=response.data,$scope.total=parseInt(response.total)})};$scope.pageChanged=function(){paginate()},$scope.changeFilterStatus=function(){$scope.currentPage=1,paginate()},$scope.onSelectCustomer=function(customer){$scope.filter.keyword=customer.display_name,$scope.searchEstimate()},$scope.searchEstimate=function(){$scope.currentPage=1,paginate()},$scope.clearSearch=function(){$scope.filter={keyword:"",status:""}},$scope.filterStatuses=[{value:"",label:"All"},{value:"Pending",label:"Pending"},{value:"Accepted",label:"Accepted"},{value:"Routed",label:"Routed"},{value:"Completed",label:"Completed/WFI"},{value:"Closed",label:"Closed"},{value:"Rejected",label:"Rejected"}],$scope.startCheckGeolocation=function(){$scope.isCheckingGeoLocation=!0,window.scrollTo(0,angular.element("#erp-content")[0].offsetTop-100);for(var errorsCount=0,delay=200,nextItemIndex=0,geocoder=new google.maps.Geocoder,itemsCount=$scope.estimates.length,i=0;itemsCount>i;i++)"undefined"==typeof $scope.estimates[i].geolocation&&($scope.estimates[i].geolocation={}),$scope.estimates[i].geolocation.is_checked=!1;var checkEstimate=function(next){var estimate=$scope.estimates[nextItemIndex],fullAddress=estimate.job_address+" "+estimate.job_city+" "+estimate.job_state+" "+estimate.job_zip_code;estimate.geolocation.is_checking=!0,$scope.$apply(),geocoder.geocode({address:fullAddress},function(results,status){status==google.maps.GeocoderStatus.OK&&results.length>0?(estimate.geolocation.ok=!0,estimate.geolocation.is_checking=!1,estimate.geolocation.is_checked=!0):status==google.maps.GeocoderStatus.OVER_QUERY_LIMIT?(nextItemIndex--,delay+=200):(estimate.geolocation.is_checking=!1,estimate.geolocation.is_checked=!0,estimate.geolocation.ok=!1,errorsCount++),$scope.$apply(),nextItemIndex==itemsCount&&($scope.isCheckingGeoLocation=!1,$timeout(function(){errorsCount>0?toastr.error("Found "+errorsCount+" items has geolocation issue!"):toastr.success("No any geolocation issues found")},500)),next()})},startCheck=function(){itemsCount>nextItemIndex&&setTimeout(function(){checkEstimate(startCheck),nextItemIndex++},delay)};startCheck()},$scope.openSendMailModal=function(estimate){$scope.showModal=!0,$scope.sendMailData.id=estimate.id,$scope.sendMailData.to=estimate.email,$scope.sendMailData.subject="Estimate from "+sharedData.companyInfo.name,$scope.sendMailData.body="",$scope.sendEmailForm.$setPristine()},$scope.sendMailEstimate=function(){$scope.showModal=!1,estimateFactory.sendMail($scope.sendMailData).success(function(response){response.success?toastr.success(response.message):toastr.error(response.message)}).error(function(){toastr.error("An error has occurred while sending estimate.")})},paginate()}function attachmentUploader($http){return{upload:function(estimate){return $http.post(ERPApp.baseAPIPath,{_do:"uploadAttachment"})},destroy:function(id){return $http.post(ERPApp.baseAPIPath,{_do:"deleteAttachment",data:{id:id}})}}}function estimateFactory($http){return{save:function(estimate){return $http.post(ERPApp.baseAPIPath,{_do:"addEstimate",data:estimate})},listAssigedToRoute:function(routeId){return $http.post(ERPApp.baseAPIPath,{_do:"getAssignedEstimates",data:{id:routeId}})},list:function(query){return $http.get(ERPApp.baseAPIPath,{params:query})},show:function(id){return $http.post(ERPApp.baseAPIPath,{_do:"showEstimate",data:{id:id}})},update:function(estimate){return $http.post(ERPApp.baseAPIPath,{_do:"updateEstimate",data:estimate})},listAssignable:function(){return $http.get(ERPApp.baseAPIPath,{params:{_do:"getAssignableEstimates"}})},sendMail:function(mailData){return $http.post(ERPApp.baseAPIPath,{_do:"sendEstimate",data:mailData})},attachments:function(id){return $http.post(ERPApp.baseAPIPath,{_do:"getEstimateAttachments",data:{id:id}})}}}function AddCrewRouteCtrl($scope,$rootScope,estimateFactory,crewRouteFactory,$location,uiGmapGoogleMapApi,uiGmapIsReady,$filter,erpOptions,sharedData,erpGeoLocation){var orderBy=$filter("orderBy"),directionsService=new google.maps.DirectionsService;$scope.setPageTitle("New Crew Route"),$scope.route={},$scope.pendingEstimates=[],$scope.assignedEstimates=[],$scope.recentRoutes=[],$scope.pendingMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/blue-marker.png"},$scope.startMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/grey-marker.png"},$scope.firstMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/green-marker.png"
},$scope.middleMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/purple-marker.png"},$scope.lastMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/red-marker.png"},$scope.map={control:{}},$scope.map.options={},$scope.assigned_queue_sort_by="",$scope.pending_queue_sort_by="",$scope.routeOrigin=null,$scope.routeOriginAddress=sharedData.companyInfo.full_address,$scope.sortOptions=erpOptions.sortCrewRoute,$scope.directionRenderers=[],$scope.viewOptions={compact:!0},erpGeoLocation.resolve($scope.routeOriginAddress).then(function(result){$scope.routeOrigin={latitude:result.lat(),longitude:result.lng()},uiGmapGoogleMapApi.then(function(maps){return $scope.map.options={center:{latitude:$scope.routeOrigin.latitude,longitude:$scope.routeOrigin.longitude},zoom:14},maps})},function(){toastr.error("Could not find geo location of company address! The route could not draw!")}),estimateFactory.listAssignable().success(function(response){angular.forEach(response,function(estimate){estimate.job_lat&&estimate.job_lng&&(estimate.coords={latitude:estimate.job_lat,longitude:estimate.job_lng},estimate.markerEvents={click:function(){$scope.clearHighlights(),estimate.highlight=!0}},estimate.markerOptions={icon:$scope.pendingMarkerIcon},estimate.total=parseFloat(estimate.total),$scope.pendingEstimates.push(estimate))})}),crewRouteFactory.recent().success(function(response){$scope.recentRoutes=response}),$scope.assignedListDndOptions={dragStart:function(){return $scope.assigned_queue_sort_by="",!0},dropped:function(evt){return(evt.source.nodesScope.$id!=evt.dest.nodesScope.$id||evt.dest.index!=evt.source.index)&&$scope.drawRouteDirection(),!0}},$scope.pendingListDndOptions={dragStart:function(evt){return $scope.pending_queue_sort_by="",!0},dropped:function(evt){return evt.source.nodesScope.$id!=evt.dest.nodesScope.$id&&$scope.drawRouteDirection(),!0}},$scope.sortAssignedQueue=function(){$scope.assignedEstimates.length>1&&($scope.assignedEstimates=orderBy($scope.assignedEstimates,$scope.assigned_queue_sort_by,!1),$scope.drawRouteDirection())},$scope.sortPendingQueue=function(){$scope.pendingEstimates.length>1&&($scope.pendingEstimates=orderBy($scope.pendingEstimates,$scope.pending_queue_sort_by,!1))};var clearDirections=function(){for(var i=0;i<$scope.directionRenderers.length;i++)$scope.directionRenderers[i].set("directions",null),delete $scope.directionRenderers[i];$scope.directionRenderers=[]},refreshMarkers=function(){angular.forEach($scope.pendingEstimates,function(estimate,index){var markerOptions={icon:$scope.pendingMarkerIcon};estimate.markerOptions=markerOptions}),angular.forEach($scope.assignedEstimates,function(estimate,index){var markerOptions={label:{text:erpOptions.map.markerLabels[index],color:"#FFF",fontWeight:"600"}};0===index?(markerOptions.label.backgroundColor=erpOptions.map.firstPointColor,markerOptions.icon=$scope.firstMarkerIcon):index+1===$scope.assignedEstimates.length?(markerOptions.label.backgroundColor=erpOptions.map.lastPointColor,markerOptions.icon=$scope.lastMarkerIcon):(markerOptions.label.backgroundColor=erpOptions.map.middlePointColor,markerOptions.icon=$scope.middleMarkerIcon),estimate.markerOptions=markerOptions})};$scope.drawRouteDirection=function(){if(refreshMarkers(),null===$scope.routeOrigin)return void toastr.error("Could not find geo location of company address! The route could not draw!");if(clearDirections(),!($scope.assignedEstimates.length<1)){$scope.loadingOn();var originLatLng=new google.maps.LatLng($scope.routeOrigin.latitude,$scope.routeOrigin.longitude),waypts=[{location:originLatLng}];angular.forEach($scope.assignedEstimates,function(estimate,index){var point={},latLng=new google.maps.LatLng(estimate.coords.latitude,estimate.coords.longitude);point.location=latLng,waypts.push(point)});for(var waypointsCount=waypts.length,MAX_WAYPOINTS_EXCEEDED=8,i=0,j=waypointsCount;j>i&&i+1!=waypointsCount;i+=MAX_WAYPOINTS_EXCEEDED-1){var part=waypts.slice(i,i+MAX_WAYPOINTS_EXCEEDED),request={origin:part[0],waypoints:part,destination:part[part.length-1],optimizeWaypoints:!0,travelMode:google.maps.TravelMode.DRIVING};directionsService.route(request,function(response,status){var directionRenderer=new google.maps.DirectionsRenderer({suppressMarkers:!0,polylineOptions:erpOptions.map.polylineOptions});$scope.directionRenderers.push(directionRenderer),directionRenderer.setMap($scope.map.control.getGMap()),$scope.loadingOff(),$scope.$apply(),status==google.maps.DirectionsStatus.OK?directionRenderer.setDirections(response):toastr.error("Could not find route on the map!")})}}},$scope.moveItemToPendingQueue=function(estimate){$scope.pending_queue_sort_by="",$scope.assigned_queue_sort_by="";for(var i=0;i<$scope.assignedEstimates.length;i++)$scope.assignedEstimates[i].id==estimate.id&&$scope.assignedEstimates.splice(i,1);$scope.pendingEstimates.push(estimate),$scope.drawRouteDirection()},$scope.moveItemToAssignedQueue=function(estimate){$scope.pending_queue_sort_by="",$scope.assigned_queue_sort_by="";for(var i=0;i<$scope.pendingEstimates.length;i++)$scope.pendingEstimates[i].id==estimate.id&&$scope.pendingEstimates.splice(i,1);$scope.assignedEstimates.push(estimate),$scope.drawRouteDirection()},$scope.openMarker=function(estimate){estimate.show_infor_window=!0,$scope.map.control.getGMap().setCenter(new google.maps.LatLng(estimate.coords.latitude,estimate.coords.longitude))},$scope.clearHighlights=function(){for(var i=0;i<$scope.pendingEstimates.length;i++)$scope.pendingEstimates[i].highlight=!1;for(var j=0;j<$scope.assignedEstimates.length;j++)$scope.assignedEstimates[j].highlight=!1},$scope.saveRoute=function(){var data={};data.title=$scope.route.title,data.assigned_estimate_ids=[],angular.forEach($scope.assignedEstimates,function(estimate){data.assigned_estimate_ids.push(estimate.id)}),crewRouteFactory.save(data).success(function(response){if(response.success)toastr.success(response.message),$location.path("/edit-crew-route/"+response.data.id);else{var msg=response.message||"An error occurred while saving route";toastr.error(msg)}})},$scope.printRoute=function(){if(null===$scope.routeOrigin)return void toastr.error("Could not find geo location of company address! The route could not draw!");if($scope.assignedEstimates.length<1)toastr.error("Print route require at least 1 estimate!");else{var url="https://www.google.com/maps/dir/am=t"+getGmapURL();window.open(url,"_blank")}};var getGmapURL=function(){var latlngs=[];latlngs.push({latitude:$scope.routeOrigin.latitude,longitude:$scope.routeOrigin.longitude}),angular.forEach($scope.assignedEstimates,function(estimate){latlngs.push(estimate.coords)});var result="";return angular.forEach(latlngs,function(point){result+="/"+point.latitude+","+point.longitude}),result}}function EditCrewRouteCtrl($scope,$rootScope,estimateFactory,crewRouteFactory,$location,$routeParams,uiGmapGoogleMapApi,uiGmapIsReady,$filter,erpOptions,sharedData,erpGeoLocation){var orderBy=$filter("orderBy"),directionsService=new google.maps.DirectionsService;$scope.setPageTitle("Crew Route planner"),$scope.route={},$scope.pendingEstimates=[],$scope.assignedEstimates=[],$scope.currentAssignedEstimates=[],$scope.pendingMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/blue-marker.png"},$scope.startMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/grey-marker.png"},$scope.firstMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/green-marker.png"},$scope.middleMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/purple-marker.png"},$scope.lastMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/red-marker.png"},$scope.map={control:{}},$scope.map.options={},$scope.assigned_queue_sort_by="",$scope.pending_queue_sort_by="",$scope.routeOrigin=null,$scope.routeOriginAddress=sharedData.companyInfo.full_address,$scope.sortOptions=erpOptions.sortCrewRoute,$scope.directionRenderers=[],$scope.viewOptions={compact:!0},crewRouteFactory.get($routeParams.id).success(function(response){$scope.route.id=response.id,$scope.route.title=response.title,angular.forEach(response.assigned_estimates,function(estimate,index){estimate.coords={latitude:estimate.job_lat,longitude:estimate.job_lng},estimate.markerEvents={click:function(){$scope.clearHighlights(),estimate.highlight=!0}};var markerOptions={label:{text:erpOptions.map.markerLabels[index],color:"#FFF",fontWeight:"600"}};0===index?(markerOptions.label.backgroundColor=erpOptions.map.firstPointColor,markerOptions.icon=$scope.firstMarkerIcon):index+1===response.assigned_estimates.length?(markerOptions.label.backgroundColor=erpOptions.map.lastPointColor,markerOptions.icon=$scope.lastMarkerIcon):(markerOptions.label.backgroundColor=erpOptions.map.middlePointColor,markerOptions.icon=$scope.middleMarkerIcon),estimate.markerOptions=markerOptions,estimate.total=parseFloat(estimate.total),$scope.assignedEstimates.push(estimate),$scope.currentAssignedEstimates.push(estimate)}),erpGeoLocation.resolve($scope.routeOriginAddress).then(function(result){$scope.routeOrigin={latitude:result.lat(),longitude:result.lng()},uiGmapGoogleMapApi.then(function(maps){return $scope.map.options={center:{latitude:$scope.routeOrigin.latitude,longitude:$scope.routeOrigin.longitude},zoom:14},maps}),uiGmapIsReady.promise(1).then(function(instances){$scope.drawRouteDirection()})},function(){toastr.error("Could not find geo location of company address! The route could not draw!")})}),estimateFactory.listAssignable().success(function(response){angular.forEach(response,function(estimate){estimate.job_lat&&estimate.job_lng&&(estimate.coords={latitude:estimate.job_lat,longitude:estimate.job_lng},estimate.markerEvents={click:function(){$scope.clearHighlights(),estimate.highlight=!0}},estimate.markerOptions={icon:$scope.pendingMarkerIcon},estimate.total=parseFloat(estimate.total),$scope.pendingEstimates.push(estimate))})}),$scope.assignedListDndOptions={dragStart:function(){return $scope.assigned_queue_sort_by="",!0},dropped:function(evt){return(evt.source.nodesScope.$id!=evt.dest.nodesScope.$id||evt.dest.index!=evt.source.index)&&$scope.drawRouteDirection(),!0}},$scope.pendingListDndOptions={dragStart:function(evt){return $scope.pending_queue_sort_by="",!0},dropped:function(evt){return evt.source.nodesScope.$id!=evt.dest.nodesScope.$id&&$scope.drawRouteDirection(),!0}},$scope.sortAssignedQueue=function(){$scope.assignedEstimates.length>1&&($scope.assignedEstimates=orderBy($scope.assignedEstimates,$scope.assigned_queue_sort_by,!1),$scope.drawRouteDirection())},$scope.sortPendingQueue=function(){$scope.pendingEstimates.length>1&&($scope.pendingEstimates=orderBy($scope.pendingEstimates,$scope.pending_queue_sort_by,!1))};var clearDirections=function(){for(var i=0;i<$scope.directionRenderers.length;i++)$scope.directionRenderers[i].set("directions",null),delete $scope.directionRenderers[i];$scope.directionRenderers=[]},refreshMarkers=function(){angular.forEach($scope.pendingEstimates,function(estimate,index){var markerOptions={icon:$scope.pendingMarkerIcon};estimate.markerOptions=markerOptions}),angular.forEach($scope.assignedEstimates,function(estimate,index){var markerOptions={label:{text:erpOptions.map.markerLabels[index],color:"#FFF",fontWeight:"600"}};0===index?(markerOptions.label.backgroundColor=erpOptions.map.firstPointColor,markerOptions.icon=$scope.firstMarkerIcon):index+1===$scope.assignedEstimates.length?(markerOptions.label.backgroundColor=erpOptions.map.lastPointColor,markerOptions.icon=$scope.lastMarkerIcon):(markerOptions.label.backgroundColor=erpOptions.map.middlePointColor,markerOptions.icon=$scope.middleMarkerIcon),estimate.markerOptions=markerOptions})};$scope.drawRouteDirection=function(){if(refreshMarkers(),null===$scope.routeOrigin)return void toastr.error("Could not find geo location of company address! The route could not draw!");if($scope.assignedEstimates.length<1)return void clearDirections();clearDirections(),$scope.loadingOn();var originLatLng=new google.maps.LatLng($scope.routeOrigin.latitude,$scope.routeOrigin.longitude),waypts=[{location:originLatLng}];angular.forEach($scope.assignedEstimates,function(estimate,index){var point={},latLng=new google.maps.LatLng(estimate.coords.latitude,estimate.coords.longitude);point.location=latLng,waypts.push(point)});for(var waypointsCount=waypts.length,MAX_WAYPOINTS_EXCEEDED=8,i=0,j=waypointsCount;j>i&&i+1!=waypointsCount;i+=MAX_WAYPOINTS_EXCEEDED-1){var part=waypts.slice(i,i+MAX_WAYPOINTS_EXCEEDED),request={origin:part[0],waypoints:part,destination:part[part.length-1],optimizeWaypoints:!0,travelMode:google.maps.TravelMode.DRIVING};directionsService.route(request,function(response,status){var directionRenderer=new google.maps.DirectionsRenderer({suppressMarkers:!0,polylineOptions:erpOptions.map.polylineOptions});$scope.directionRenderers.push(directionRenderer),directionRenderer.setMap($scope.map.control.getGMap()),$scope.loadingOff(),$scope.$apply(),status==google.maps.DirectionsStatus.OK?directionRenderer.setDirections(response):toastr.error("Could not find route on the map!")})}},$scope.moveItemToPendingQueue=function(estimate){$scope.pending_queue_sort_by="",$scope.assigned_queue_sort_by="";for(var i=0;i<$scope.assignedEstimates.length;i++)$scope.assignedEstimates[i].id==estimate.id&&$scope.assignedEstimates.splice(i,1);$scope.pendingEstimates.push(estimate),$scope.drawRouteDirection()},$scope.moveItemToAssignedQueue=function(estimate){$scope.pending_queue_sort_by="",$scope.assigned_queue_sort_by="";for(var i=0;i<$scope.pendingEstimates.length;i++)$scope.pendingEstimates[i].id==estimate.id&&$scope.pendingEstimates.splice(i,1);$scope.assignedEstimates.push(estimate),$scope.drawRouteDirection()},$scope.openMarker=function(estimate){estimate.show_infor_window=!0,$scope.map.control.getGMap().setCenter(new google.maps.LatLng(estimate.coords.latitude,estimate.coords.longitude))},$scope.clearHighlights=function(){for(var i=0;i<$scope.pendingEstimates.length;i++)$scope.pendingEstimates[i].highlight=!1;for(var j=0;j<$scope.assignedEstimates.length;j++)$scope.assignedEstimates[j].highlight=!1},$scope.saveRoute=function(){var data={};data.id=$scope.route.id,data.title=$scope.route.title,data.assigned_estimate_ids=[],angular.forEach($scope.assignedEstimates,function(estimate){data.assigned_estimate_ids.push(estimate.id)}),crewRouteFactory.update(data).success(function(response){if(response.success)angular.forEach($scope.assignedEstimates,function(estimate){"Accepted"===estimate.status&&(estimate.status="Routed")}),angular.forEach($scope.pendingEstimates,function(estimate){estimate.status="Accepted"}),toastr.success(response.message),$scope.currentAssignedEstimates=[],angular.copy($scope.assignedEstimates,$scope.currentAssignedEstimates);else{var msg=response.message||"An error occurred while saving estimate";toastr.error(msg)}})},$scope.printRoute=function(){if(null===$scope.routeOrigin)return void toastr.error("Could not find geo location of company address! The route could not draw!");if($scope.assignedEstimates.length<1)toastr.error("Print route require at least 1 estimate!");else{var url="https://www.google.com/maps/dir/am=t"+getGmapURL();window.open(url,"_blank")}};var getGmapURL=function(){var latlngs=[];latlngs.push({latitude:$scope.routeOrigin.latitude,longitude:$scope.routeOrigin.longitude}),angular.forEach($scope.assignedEstimates,function(estimate){latlngs.push(estimate.coords)});var result="";return angular.forEach(latlngs,function(point){result+="/"+point.latitude+","+point.longitude}),result}}function ListCrewRouteCtrl($scope,$rootScope,$routeParams,crewRouteFactory,erpOptions,$ngBootbox){$scope.setPageTitle("Crew Routes List"),$scope.routes=[],$scope.filter={},$scope.total=0;var currentPage=1;"undefined"!=typeof $routeParams.pageNumber&&(currentPage=$routeParams.pageNumber),$scope.currentPage=currentPage;var paginate=function(){var query={_do:"getCrewRoutes",page:$scope.currentPage,keyword:$scope.filter.keyword};crewRouteFactory.all(query).success(function(response){$scope.routes=response.routes,$scope.total=parseInt(response.total)})};$scope.pageChanged=function(){paginate()},$scope.searchRoute=function(){$scope.currentPage=1,paginate()},$scope.clearSearch=function(){$scope.filter={},paginate()},paginate()}function WorkOrderCtrl($scope,$rootScope,$routeParams,crewRouteFactory,estimateFactory){$scope.setPageTitle("Work Order"),$scope.route={assignedEstimates:[]},$scope.work_order={},$scope.route_id=$routeParams.id,crewRouteFactory.get($scope.route_id).success(function(routeData){$scope.route=routeData,$scope.route.assignedEstimates=[],crewRouteFactory.showWorkOrder($scope.route_id).success(function(workOrderData){$scope.work_order=workOrderData}),estimateFactory.listAssigedToRoute($scope.route_id).success(function(responseData){angular.forEach(responseData,function(estimate){estimate.estimators=[],estimate.sold_by_1&&estimate.estimators.push(estimate.sold_by_1),estimate.sold_by_2&&estimate.estimators.push(estimate.sold_by_2),$scope.route.assignedEstimates.push(estimate),angular.forEach(estimate.lines,function(line){line.is_empty=!line.product_service_id&&!line.description,line.is_empty||(line.worker_order_line="",line.qty&&(line.worker_order_line+=line.qty+" - "),null!==line.description&&(line.worker_order_line+=line.description))})})})}),$scope.print=function(){window.print()},$scope.save=function(){var data={};data.route_id=$scope.route_id,data.equipment_list=$scope.work_order.equipment_list,data.start_time=$scope.work_order.start_time,crewRouteFactory.saveWorkOrder(data).success(function(response){response.success?toastr.success(response.message):toastr.error(response.message)})}}function crewRouteFactory($http){return{get:function(id){return $http.post(ERPApp.baseAPIPath,{_do:"getCrewRoute",data:{id:id}})},all:function(query){return $http.get(ERPApp.baseAPIPath,{params:query})},save:function(data){return $http.post(ERPApp.baseAPIPath,{_do:"saveCrewRoute",data:data})},update:function(data){return $http.post(ERPApp.baseAPIPath,{_do:"updateCrewRoute",data:data})},showWorkOrder:function(routeId){return $http.post(ERPApp.baseAPIPath,{_do:"showWorkOrder",data:{route_id:routeId}})},saveWorkOrder:function(data){return $http.post(ERPApp.baseAPIPath,{_do:"saveWorkOrder",data:data})},recent:function(){return $http.get(ERPApp.baseAPIPath,{params:{_do:"getRecentCrewRoutes"}})}}}function formCrewRoute(APP_CONFIG,erpOptions){return{restrict:"E",templateUrl:APP_CONFIG.templatesPath+"crew-route/form.html",controller:["$scope",function($scope){$scope.employees=[],$scope.routeStatuses=erpOptions.routeStatuses}]}}function productServiceFactory($http){return{all:function(){return $http.get(ERPApp.baseAPIPath,{params:{_do:"getProductServices"}})}}}function QuickbooksSyncCtrl($scope,$window,quickbooksSyncFactory,erpLocalStorage,$ngBootbox){$scope.setPageTitle("Quickbooks Synchronize"),$scope.info={},$scope.startSync=function(){toastr.warning("Please wait, this might take few minutes to to finish .."),quickbooksSyncFactory.startSync().success(function(response){if(response.success)toastr.success(response.message),erpLocalStorage.clearCustomers(),erpLocalStorage.clearProductServices(),erpLocalStorage.clearClasses();else{var msg=response.message||"An error has occurred while synchrinize data";toastr.error(msg)}loadInfo()}).error(function(data,status,header,config){408==status?toastr.warning("Timeout waiting for response!"):(toastr.error("An error has occurred while synchrinize data"),loadInfo())})},$scope.reconnect=function(){$ngBootbox.confirm("Are you sure? This action cannot be undone. It's will clear the current OAuth keys, and you have to reconnect.").then(function(){quickbooksSyncFactory.reconnect().success(function(response){response.success?$window.location.reload():toastr.error(response.message)}).error(function(data,status,header,config){toastr.error("An error has occurred")})})};var loadInfo=function(){quickbooksSyncFactory.getInfo().success(function(response){$scope.info={};var info=response;info.last_sync_at&&(info.last_sync_at=new Date(info.last_sync_at+" "+ERPApp.timezone)),$scope.info=info})};loadInfo()}function quickbooksSyncFactory($http){return{getInfo:function(){return $http.get(ERPApp.baseAPIPath,{params:{_do:"getSyncInfo"}})},saveSetting:function(setting){return $http.post(ERPApp.baseAPIPath,{_do:"saveSyncSetting",data:setting})},startSync:function(){return $http.post(ERPApp.baseAPIPath,{_do:"syncAll"},{timeout:36e5})},reconnect:function(){return $http.post(ERPApp.baseAPIPath,{_do:"reconnectQuickbooks"})}}}function AddJobRequestCtrl($scope,$rootScope,jobRequestFactory,erpLocalStorage,sharedData,$location,$filter,$uibModal,erpGeoLocation){function saveReferral(){var referralData={};angular.copy($scope.referral,referralData),referralData.date_service=$filter("date")(referralData.date_service,"yyyy-MM-dd"),referralData.date_requested=$filter("date")(referralData.date_requested,"yyyy-MM-dd"),jobRequestFactory.save(referralData).success(function(response){if(response.success)toastr.success(response.message),$location.path("/edit-job-request/"+response.data.id);else{var msg=response.message||"An error occurred while saving job request";toastr.error(msg)}})}function getFullAddress(){return $scope.referral.address+" "+$scope.referral.city+" "+$scope.referral.state+" "+$scope.referral.zip_code}$scope.setPageTitle("New Job Request"),$scope.companyInfo={},$scope.customers=[],$scope.employees=[],$scope.classes=[],angular.copy(sharedData.companyInfo,$scope.companyInfo),$scope.referral={status:"Pending"},erpLocalStorage.getCustomers().then(function(data){$scope.customers=[],angular.copy(data,$scope.customers)}),erpLocalStorage.getEmployees().then(function(data){$scope.employees=[],angular.copy(data,$scope.employees)}),erpLocalStorage.getClasses().then(function(data){$scope.classes=[],angular.copy(data,$scope.classes)}),$scope.onCustomerUpdate=function(){resetCustomer()},$scope.onCustomerChange=function(){resetCustomer()};var resetCustomer=function(){"undefined"!=typeof $scope.referral.customer_id&&erpLocalStorage.getCustomers().then(function(customers){angular.forEach(customers,function(cus){return cus.id==$scope.referral.customer_id?($scope.referral.address=cus.ship_address,$scope.referral.city=cus.ship_city,$scope.referral.state=cus.ship_state,$scope.referral.zip_code=cus.ship_zip_code,$scope.referral.country=cus.ship_country,$scope.referral.primary_phone_number=cus.primary_phone_number,$scope.referral.mobile_phone_number=cus.mobile_phone_number,void($scope.referral.email=cus.email)):void 0})})};$scope.submitForm=function(){$scope.referral.address&&$scope.referral.address.length?erpGeoLocation.resolve(getFullAddress()).then(function(result){$scope.referral.lat=result.lat(),$scope.referral.lng=result.lng(),saveReferral()},function(){toastr.error("Could not find geo location. Please check the address!")}):saveReferral()}}function EditJobRequestCtrl($scope,$rootScope,jobRequestFactory,erpLocalStorage,sharedData,$routeParams,$filter,$window,erpGeoLocation){function saveReferral(){var referral={};angular.copy($scope.referral,referral),referral.date_service=$filter("date")(referral.date_service,"yyyy-MM-dd"),referral.date_requested=$filter("date")(referral.date_requested,"yyyy-MM-dd"),jobRequestFactory.update(referral).success(function(response){if(response.success)toastr.success(response.message),$scope.referralForm.$setPristine();else{var msg=response.message||"An error occurred while saving job request";toastr.error(msg)}})}function getFullAddress(){return $scope.referral.address+" "+$scope.referral.city+" "+$scope.referral.state+" "+$scope.referral.zip_code}$scope.setPageTitle("Edit Job Request"),$scope.companyInfo={},$scope.customers=[],$scope.employees=[],$scope.classes=[],angular.copy(sharedData.companyInfo,$scope.companyInfo);var init=function(){jobRequestFactory.show($routeParams.id).success(function(response){$scope.referral=response,erpLocalStorage.getCustomers().then(function(data){var customers=data;"0"==$scope.referral.customer_active&&customers.push({id:$scope.referral.customer_id,display_name:$scope.referral.customer_display_name,order:customers.length}),angular.copy(customers,$scope.customers)}),erpLocalStorage.getEmployees().then(function(data){$scope.employees=[],angular.copy(data,$scope.employees)}),erpLocalStorage.getClasses().then(function(data){$scope.classes=[],angular.copy(data,$scope.classes)})})};$scope.onCustomerUpdate=function(){resetCustomer()};var resetCustomer=function(){"undefined"!=typeof $scope.referral.customer_id&&erpLocalStorage.getCustomers().then(function(customers){angular.forEach(customers,function(cus){return cus.id==$scope.referral.customer_id?($scope.referral.address=cus.ship_address,$scope.referral.city=cus.ship_city,$scope.referral.state=cus.ship_state,$scope.referral.zip_code=cus.ship_zip_code,$scope.referral.country=cus.ship_country,$scope.referral.primary_phone_number=cus.primary_phone_number,$scope.referral.mobile_phone_number=cus.mobile_phone_number,void($scope.referral.email=cus.email)):void 0})})};$scope.onCustomerChange=function(){resetCustomer()},$scope.submitForm=function(){$scope.referral.address&&$scope.referral.address.length?erpGeoLocation.resolve(getFullAddress()).then(function(result){$scope.referral.lat=result.lat(),$scope.referral.lng=result.lng(),saveReferral()},function(){toastr.error("Could not find geo location. Please check the address!")}):saveReferral()},init()}function ListJobRequestCtrl($scope,$routeParams,jobRequestFactory,estimateRouteFactory,erpLocalStorage,erpGeoLocation,erpOptions,$ngBootbox,$timeout){$scope.setPageTitle("Job Requests List"),$scope.referrals={},$scope.date=new Date,$scope.routes=[],$scope.showAssignModal=!1,$scope.filter={},$scope.total=0,$scope.referralStatuses=erpOptions.referralStatuses,$scope.isCheckingGeoLocation=!1;var currentPage=1;"undefined"!=typeof $routeParams.pageNumber&&(currentPage=$routeParams.pageNumber),$scope.currentPage=currentPage,estimateRouteFactory.all().success(function(responseData){angular.forEach(responseData,function(route){route.label=route.title+" ( "+route.status+" )",$scope.routes.push(route)})}),erpLocalStorage.getEmployees().then(function(data){$scope.employees=[],angular.copy(data,$scope.employees)});var paginate=function(){var query={_do:"getReferrals",page:$scope.currentPage,keyword:$scope.filter.keyword};jobRequestFactory.list(query).success(function(response){$scope.referrals=response.data,$scope.total=parseInt(response.total)})};$scope.pageChanged=function(){paginate()},$scope.onSelectCustomer=function(customer){$scope.filter.keyword=customer.display_name,$scope.searchReferral()},$scope.searchReferral=function(){$scope.currentPage=1,paginate()},$scope.clearSearch=function(){$scope.filter={},paginate()},$scope.showModalUpdateStatus=function(referral){$scope.currentReferral={},$scope.currentReferral.id=referral.id,$scope.currentReferral.status=referral.new_status,"Assigned"==referral.new_status?$scope.showAssignModal=!0:$ngBootbox.confirm("Do you want to save job request status?").then(function(){$scope.showAssignModal=!1,$scope.updateReferralStatus(),$scope.currentReferral={}},function(){referral.new_status=referral.status,$scope.currentReferral={},$scope.assignReferralForm.$setPristine()})},$scope.cancelAssignReferral=function(){$scope.showAssignModal=!1,angular.forEach($scope.referrals,function(referral){return referral.id==$scope.currentReferral.id?void(referral.new_status=referral.status):void 0}),$scope.currentReferral={},$scope.assignReferralForm.$setPristine()},$scope.startCheckGeolocation=function(){$scope.isCheckingGeoLocation=!0,window.scrollTo(0,angular.element("#erp-content")[0].offsetTop-100);for(var errorsCount=0,delay=200,nextItemIndex=0,geocoder=new google.maps.Geocoder,itemsCount=$scope.referrals.length,i=0;itemsCount>i;i++)"undefined"==typeof $scope.referrals[i].geolocation&&($scope.referrals[i].geolocation={}),$scope.referrals[i].geolocation.is_checked=!1;var checkReferral=function(next){var ref=$scope.referrals[nextItemIndex],fullAddress=ref.address+" "+ref.city+" "+ref.state+" "+ref.zip_code;ref.geolocation.is_checking=!0,$scope.$apply(),geocoder.geocode({address:fullAddress},function(results,status){status==google.maps.GeocoderStatus.OK&&results.length>0?(ref.geolocation.ok=!0,ref.geolocation.is_checking=!1,ref.geolocation.is_checked=!0):status==google.maps.GeocoderStatus.OVER_QUERY_LIMIT?(nextItemIndex--,delay+=200):(ref.geolocation.is_checking=!1,ref.geolocation.is_checked=!0,ref.geolocation.ok=!1,errorsCount+=1),$scope.$apply(),nextItemIndex==itemsCount&&($scope.isCheckingGeoLocation=!1,$timeout(function(){errorsCount>0?toastr.error("Found "+errorsCount+" items has geolocation issue!"):toastr.success("No any geolocation issues found")},500)),next()})},startCheck=function(){itemsCount>nextItemIndex&&setTimeout(function(){checkReferral(startCheck),nextItemIndex++},delay)};startCheck()},$scope.updateReferralStatus=function(){if($scope.currentReferral){$scope.showAssignModal=!1;var newStatus=$scope.currentReferral.status,updateReferralId=$scope.currentReferral.id;jobRequestFactory.updateStatus($scope.currentReferral).success(function(response){if(response.success)toastr.success(response.message),"Completed"===newStatus&&angular.forEach($scope.referrals,function(referral,index){return referral.id==updateReferralId?void $scope.referrals.splice(index,1):void 0});else{var errorMsg=response.message||"An error has occurred while saving route";toastr.error(errorMsg)}}).then(function(){$scope.currentReferral={},$scope.assignReferralForm.$setPristine()})}},paginate()}function jobRequestFactory($http){return{save:function(referral){return $http.post(ERPApp.baseAPIPath,{_do:"addReferral",data:referral})},list:function(query){return $http.get(ERPApp.baseAPIPath,{params:query})},listPending:function(){return $http.get(ERPApp.baseAPIPath,{params:{_do:"getPendingReferrals"}})},show:function(id){return $http.post(ERPApp.baseAPIPath,{_do:"showReferral",data:{id:id}})},update:function(referral){return $http.post(ERPApp.baseAPIPath,{_do:"updateReferral",data:referral})},updateStatus:function(data){return $http.post(ERPApp.baseAPIPath,{_do:"updateReferralStatus",data:data})}}}function AddEstimateRouteCtrl($scope,$rootScope,jobRequestFactory,estimateRouteFactory,sharedData,$location,$filter,erpOptions,uiGmapGoogleMapApi,uiGmapIsReady,erpGeoLocation){var orderBy=$filter("orderBy"),directionsService=new google.maps.DirectionsService;$scope.setPageTitle("New Estimate Route"),$scope.route={status:"Pending"},$scope.pendingReferrals=[],$scope.assignedReferrals=[],$scope.recentRoutes=[],$scope.pendingMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/blue-marker.png"},$scope.startMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/grey-marker.png"},$scope.firstMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/green-marker.png"},$scope.middleMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/purple-marker.png"},$scope.lastMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/red-marker.png"},$scope.map={control:{}},$scope.map.options={},$scope.assigned_queue_sort_by="",$scope.pending_queue_sort_by="",$scope.routeOrigin=null,$scope.routeOriginAddress=sharedData.companyInfo.full_address,$scope.sortOptions=erpOptions.sortEstimateRoute,$scope.directionRenderers=[],$scope.viewOptions={compact:!0},erpGeoLocation.resolve($scope.routeOriginAddress).then(function(result){$scope.routeOrigin={latitude:result.lat(),longitude:result.lng()},uiGmapGoogleMapApi.then(function(maps){return $scope.map.options={center:{latitude:$scope.routeOrigin.latitude,longitude:$scope.routeOrigin.longitude},zoom:14},maps})},function(){toastr.error("Could not find geo location of company address! The route could not draw!")}),jobRequestFactory.listPending().success(function(response){angular.forEach(response,function(referral){referral.coords={latitude:referral.lat,longitude:referral.lng},referral.markerEvents={click:function(){$scope.clearHighlights(),referral.highlight=!0}},referral.markerOptions={icon:$scope.pendingMarkerIcon},$scope.pendingReferrals.push(referral);
})}),estimateRouteFactory.recent().success(function(response){$scope.recentRoutes=response}),$scope.assignedListDndOptions={dragStart:function(){return $scope.assigned_queue_sort_by="",!0},dropped:function(evt){return(evt.source.nodesScope.$id!=evt.dest.nodesScope.$id||evt.dest.index!=evt.source.index)&&$scope.drawRouteDirection(),!0}},$scope.pendingListDndOptions={dragStart:function(evt){return $scope.pending_queue_sort_by="",!0},dropped:function(evt){return evt.source.nodesScope.$id!=evt.dest.nodesScope.$id&&$scope.drawRouteDirection(),!0}},$scope.sortAssignedQueue=function(){$scope.assignedReferrals.length>1&&($scope.assignedReferrals=orderBy($scope.assignedReferrals,$scope.assigned_queue_sort_by,!1),$scope.drawRouteDirection())},$scope.sortPendingQueue=function(){$scope.pendingReferrals.length>1&&($scope.pendingReferrals=orderBy($scope.pendingReferrals,$scope.pending_queue_sort_by,!1))};var clearDirections=function(){for(var i=0;i<$scope.directionRenderers.length;i++)$scope.directionRenderers[i].set("directions",null),delete $scope.directionRenderers[i];$scope.directionRenderers=[]},refreshMarkers=function(){angular.forEach($scope.pendingReferrals,function(referral,index){var markerOptions={icon:$scope.pendingMarkerIcon};referral.markerOptions=markerOptions}),angular.forEach($scope.assignedReferrals,function(referral,index){var markerOptions={label:{text:erpOptions.map.markerLabels[index],color:"#FFF"}};0===index?(markerOptions.label.backgroundColor=erpOptions.map.firstPointColor,markerOptions.icon=$scope.firstMarkerIcon):index+1===$scope.assignedReferrals.length?(markerOptions.label.backgroundColor=erpOptions.map.lastPointColor,markerOptions.icon=$scope.lastMarkerIcon):(markerOptions.label.backgroundColor=erpOptions.map.middlePointColor,markerOptions.icon=$scope.middleMarkerIcon),referral.markerOptions=markerOptions})};$scope.drawRouteDirection=function(){if(refreshMarkers(),null===$scope.routeOrigin)return void toastr.error("Could not find geo location of company address! The route could not draw!");if(clearDirections(),!($scope.assignedReferrals.length<1)){$scope.loadingOn();var originLatLng=new google.maps.LatLng($scope.routeOrigin.latitude,$scope.routeOrigin.longitude),waypts=[{location:originLatLng}];angular.forEach($scope.assignedReferrals,function(referral,index){var point={},latLng=new google.maps.LatLng(referral.coords.latitude,referral.coords.longitude);point.location=latLng,waypts.push(point)});for(var waypointsCount=waypts.length,MAX_WAYPOINTS_EXCEEDED=8,i=0,j=waypointsCount;j>i&&i+1!=waypointsCount;i+=MAX_WAYPOINTS_EXCEEDED-1){var part=waypts.slice(i,i+MAX_WAYPOINTS_EXCEEDED),request={origin:part[0],waypoints:part,destination:part[part.length-1],optimizeWaypoints:!0,travelMode:google.maps.TravelMode.DRIVING};directionsService.route(request,function(response,status){var directionRenderer=new google.maps.DirectionsRenderer({suppressMarkers:!0,polylineOptions:erpOptions.map.polylineOptions});$scope.directionRenderers.push(directionRenderer),directionRenderer.setMap($scope.map.control.getGMap()),$scope.loadingOff(),$scope.$apply(),status==google.maps.DirectionsStatus.OK?directionRenderer.setDirections(response):toastr.error("Could not find route on the map!")})}}},$scope.moveItemToPendingQueue=function(referral){$scope.pending_queue_sort_by="",$scope.assigned_queue_sort_by="";for(var i=0;i<$scope.assignedReferrals.length;i++)$scope.assignedReferrals[i].id==referral.id&&$scope.assignedReferrals.splice(i,1);$scope.pendingReferrals.push(referral),$scope.drawRouteDirection()},$scope.moveItemToAssignedQueue=function(referral){$scope.pending_queue_sort_by="",$scope.assigned_queue_sort_by="";for(var i=0;i<$scope.pendingReferrals.length;i++)$scope.pendingReferrals[i].id==referral.id&&$scope.pendingReferrals.splice(i,1);$scope.assignedReferrals.push(referral),$scope.drawRouteDirection()},$scope.openMarker=function(referral){referral.show_infor_window=!0,$scope.map.control.getGMap().setCenter(new google.maps.LatLng(referral.coords.latitude,referral.coords.longitude))},$scope.clearHighlights=function(){for(var i=0;i<$scope.pendingReferrals.length;i++)$scope.pendingReferrals[i].highlight=!1;for(var j=0;j<$scope.assignedReferrals.length;j++)$scope.assignedReferrals[j].highlight=!1},$scope.saveRoute=function(){var data={};data.title=$scope.route.title,data.assigned_referral_ids=[],data.estimator_id=$scope.route.estimator_id,angular.forEach($scope.assignedReferrals,function(referral){data.assigned_referral_ids.push(referral.id)}),estimateRouteFactory.save(data).success(function(response){if(response.success)toastr.success(response.message),$location.path("/edit-estimate-route/"+response.data.id);else{var msg=response.message||"An error occurred while saving route";toastr.error(msg)}})},$scope.printRoute=function(){if(null===$scope.routeOrigin)return void toastr.error("Could not find geo location of company address! The route could not print!");if($scope.assignedReferrals.length<1)toastr.error("Print route require at least 1 assigned referral!");else{var url="https://www.google.com/maps/dir/am=t"+getGmapURL();window.open(url,"_blank")}};var getGmapURL=function(){var latlngs=[];latlngs.push({latitude:$scope.routeOrigin.latitude,longitude:$scope.routeOrigin.longitude}),angular.forEach($scope.assignedReferrals,function(referral){latlngs.push(referral.coords)});var result="";return angular.forEach(latlngs,function(point){result+="/"+point.latitude+","+point.longitude}),result}}function EditEstimateRouteCtrl($scope,$rootScope,jobRequestFactory,estimateRouteFactory,erpLocalStorage,sharedData,$routeParams,uiGmapGoogleMapApi,uiGmapIsReady,$filter,erpOptions,erpGeoLocation){var orderBy=$filter("orderBy"),directionsService=new google.maps.DirectionsService;$scope.setPageTitle("Estimate Route Planner"),$scope.route={},$scope.pendingReferrals=[],$scope.assignedReferrals=[],$scope.pendingMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/blue-marker.png"},$scope.startMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/grey-marker.png"},$scope.firstMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/green-marker.png"},$scope.middleMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/purple-marker.png"},$scope.lastMarkerIcon={url:$rootScope.baseERPPluginUrl+"images/red-marker.png"},$scope.map={control:{}},$scope.map.options={},$scope.currentAssignedReferrals=[],$scope.assigned_queue_sort_by="",$scope.pending_queue_sort_by="",$scope.routeOrigin=null,$scope.routeOriginAddress=sharedData.companyInfo.full_address,$scope.sortOptions=erpOptions.sortEstimateRoute,$scope.directionRenderers=[],$scope.viewOptions={compact:!0},estimateRouteFactory.get($routeParams.id).success(function(response){$scope.route.id=response.id,$scope.route.title=response.title,$scope.route.status=response.status,$scope.route.estimator_id=response.estimator_id,angular.forEach(response.assigned_referrals,function(referral,index){referral.coords={latitude:referral.lat,longitude:referral.lng},referral.markerEvents={click:function(){$scope.clearHighlights(),referral.highlight=!0}};var markerOptions={label:{text:erpOptions.map.markerLabels[index],color:"#FFF",fontWeight:"600"}};0===index?(markerOptions.label.backgroundColor=erpOptions.map.firstPointColor,markerOptions.icon=$scope.firstMarkerIcon):index+1===response.assigned_referrals.length?(markerOptions.label.backgroundColor=erpOptions.map.lastPointColor,markerOptions.icon=$scope.lastMarkerIcon):(markerOptions.label.backgroundColor=erpOptions.map.middlePointColor,markerOptions.icon=$scope.middleMarkerIcon),referral.markerOptions=markerOptions,$scope.assignedReferrals.push(referral),$scope.currentAssignedReferrals.push(referral)}),erpGeoLocation.resolve($scope.routeOriginAddress).then(function(result){$scope.routeOrigin={latitude:result.lat(),longitude:result.lng()},uiGmapGoogleMapApi.then(function(maps){return $scope.map.options={center:{latitude:$scope.routeOrigin.latitude,longitude:$scope.routeOrigin.longitude},zoom:14},maps}),uiGmapIsReady.promise(1).then(function(instances){$scope.drawRouteDirection()})},function(){toastr.error("Could not find geo location of company address! The route could not draw!")})}),jobRequestFactory.listPending().success(function(response){angular.forEach(response,function(referral){referral.lat&&referral.lng&&(referral.coords={latitude:referral.lat,longitude:referral.lng},referral.markerEvents={click:function(){$scope.clearHighlights(),referral.highlight=!0}},referral.markerOptions={icon:$scope.pendingMarkerIcon},$scope.pendingReferrals.push(referral))})}),$scope.assignedListDndOptions={dragStart:function(){return $scope.assigned_queue_sort_by="",!0},dropped:function(evt){return(evt.source.nodesScope.$id!=evt.dest.nodesScope.$id||evt.dest.index!=evt.source.index)&&$scope.drawRouteDirection(),!0}},$scope.pendingListDndOptions={dragStart:function(evt){return $scope.pending_queue_sort_by="",!0},dropped:function(evt){return evt.source.nodesScope.$id!=evt.dest.nodesScope.$id&&$scope.drawRouteDirection(),!0}},$scope.sortAssignedQueue=function(){$scope.assignedReferrals.length>1&&($scope.assignedReferrals=orderBy($scope.assignedReferrals,$scope.assigned_queue_sort_by,!1),$scope.drawRouteDirection())},$scope.sortPendingQueue=function(){$scope.pendingReferrals.length>1&&($scope.pendingReferrals=orderBy($scope.pendingReferrals,$scope.pending_queue_sort_by,!1))};var clearDirections=function(){for(var i=0;i<$scope.directionRenderers.length;i++)$scope.directionRenderers[i].set("directions",null),delete $scope.directionRenderers[i];$scope.directionRenderers=[]},refreshMarkers=function(){angular.forEach($scope.pendingReferrals,function(referral,index){var markerOptions={icon:$scope.pendingMarkerIcon};referral.markerOptions=markerOptions}),angular.forEach($scope.assignedReferrals,function(referral,index){var markerOptions={label:{text:erpOptions.map.markerLabels[index],color:"#FFF",fontWeight:"600"}};0===index?(markerOptions.label.backgroundColor=erpOptions.map.firstPointColor,markerOptions.icon=$scope.firstMarkerIcon):index+1===$scope.assignedReferrals.length?(markerOptions.label.backgroundColor=erpOptions.map.lastPointColor,markerOptions.icon=$scope.lastMarkerIcon):(markerOptions.label.backgroundColor=erpOptions.map.middlePointColor,markerOptions.icon=$scope.middleMarkerIcon),referral.markerOptions=markerOptions})};$scope.drawRouteDirection=function(){if(refreshMarkers(),null===$scope.routeOrigin)return void toastr.error("Could not find geo location of company address! The route could not draw!");if(clearDirections(),!($scope.assignedReferrals.length<1)){$scope.loadingOn();var originLatLng=new google.maps.LatLng($scope.routeOrigin.latitude,$scope.routeOrigin.longitude),waypts=[{location:originLatLng}];angular.forEach($scope.assignedReferrals,function(referral,index){var point={},latLng=new google.maps.LatLng(referral.coords.latitude,referral.coords.longitude);point.location=latLng,waypts.push(point)});for(var waypointsCount=waypts.length,MAX_WAYPOINTS_EXCEEDED=8,i=0,j=waypointsCount;j>i&&i+1!=waypointsCount;i+=MAX_WAYPOINTS_EXCEEDED-1){var part=waypts.slice(i,i+MAX_WAYPOINTS_EXCEEDED),request={origin:part[0],waypoints:part,destination:part[part.length-1],optimizeWaypoints:!0,travelMode:google.maps.TravelMode.DRIVING};directionsService.route(request,function(response,status){var directionRenderer=new google.maps.DirectionsRenderer({suppressMarkers:!0,polylineOptions:erpOptions.map.polylineOptions});directionRenderer.setMap($scope.map.control.getGMap()),$scope.directionRenderers.push(directionRenderer),$scope.loadingOff(),$scope.$apply(),status==google.maps.DirectionsStatus.OK?directionRenderer.setDirections(response):toastr.error("Could not find route on the map!")})}}};var updateEstimatorAssigned=function(){erpLocalStorage.getEmployees().then(function(emps){for(var i=0;i<emps.length;i++)if(emps[i].id==$scope.route.estimator_id){var estimatorAssignedFullname=emps[i].name;angular.forEach($scope.assignedReferrals,function(referral){referral.estimator_full_name=estimatorAssignedFullname});break}})};$scope.moveItemToPendingQueue=function(referral){$scope.pending_queue_sort_by="",$scope.assigned_queue_sort_by="";for(var i=0;i<$scope.assignedReferrals.length;i++)$scope.assignedReferrals[i].id==referral.id&&$scope.assignedReferrals.splice(i,1);$scope.pendingReferrals.push(referral),$scope.drawRouteDirection()},$scope.moveItemToAssignedQueue=function(referral){$scope.pending_queue_sort_by="",$scope.assigned_queue_sort_by="";for(var i=0;i<$scope.pendingReferrals.length;i++)$scope.pendingReferrals[i].id==referral.id&&$scope.pendingReferrals.splice(i,1);$scope.assignedReferrals.push(referral),$scope.drawRouteDirection()},$scope.openMarker=function(referral){referral.show_infor_window=!0,$scope.map.control.getGMap().setCenter(new google.maps.LatLng(referral.coords.latitude,referral.coords.longitude))},$scope.clearHighlights=function(){for(var i=0;i<$scope.pendingReferrals.length;i++)$scope.pendingReferrals[i].highlight=!1;for(var j=0;j<$scope.assignedReferrals.length;j++)$scope.assignedReferrals[j].highlight=!1},$scope.saveRoute=function(){var data={};data.id=$scope.route.id,data.title=$scope.route.title,data.status=$scope.route.status,data.estimator_id=$scope.route.estimator_id,data.assigned_referral_ids=[],angular.forEach($scope.assignedReferrals,function(referral){data.assigned_referral_ids.push(referral.id)}),estimateRouteFactory.update(data).success(function(response){if(response.success)toastr.success(response.message),angular.forEach($scope.assignedReferrals,function(referral){"Pending"==referral.status&&(referral.status="Assigned")}),angular.forEach($scope.pendingReferrals,function(referral){"Assigned"==referral.status&&(referral.status="Pending")}),$scope.route.estimator_id&&updateEstimatorAssigned(),$scope.currentAssignedReferrals=[],angular.copy($scope.assignedReferrals,$scope.currentAssignedReferrals);else{var msg=response.message||"An error occurred while saving referral";toastr.error(msg)}})},$scope.printRoute=function(){if(null===$scope.routeOrigin)return void toastr.error("Could not find geo location of company address! The route could not print!");if($scope.assignedReferrals.length<1)toastr.error("Print route require at least 1 assigned referral!");else{var url="https://www.google.com/maps/dir/am=t"+getGmapURL();window.open(url,"_blank")}};var getGmapURL=function(){var latlngs=[];latlngs.push({latitude:$scope.routeOrigin.latitude,longitude:$scope.routeOrigin.longitude}),angular.forEach($scope.assignedReferrals,function(referral){latlngs.push(referral.coords)});var result="";return angular.forEach(latlngs,function(point){result+="/"+point.latitude+","+point.longitude}),result}}function ListEstimateRouteCtrl($scope,$rootScope,$routeParams,estimateRouteFactory,erpOptions,$ngBootbox){$scope.setPageTitle("Estimate Routes List"),$scope.routes=[],$scope.filter={},$scope.routeStatuses=erpOptions.routeStatuses,$scope.total=0;var currentPage=1;"undefined"!=typeof $routeParams.pageNumber&&(currentPage=$routeParams.pageNumber),$scope.currentPage=currentPage;var paginate=function(){var query={_do:"filterEstimateRoutes",page:$scope.currentPage,keyword:$scope.filter.keyword};estimateRouteFactory.filter(query).success(function(response){$scope.routes=response.routes,$scope.total=parseInt(response.total)})};$scope.saveRouteStatus=function(route){$ngBootbox.confirm("Do want to save this route?").then(function(){var data={};data.id=route.id,data.status=route.new_status,estimateRouteFactory.updateStatus(data).success(function(response){if(route.status=route.new_status,response.success)toastr.success(response.message);else{var errorMsg=response.message||"An error has occurred while saving route";toastr.error(errorMsg)}})},function(){route.new_status=route.status})},$scope.pageChanged=function(){paginate()},$scope.clearSearch=function(){$scope.filter={},paginate()},$scope.searchRoute=function(){$scope.currentPage=1,paginate()},paginate()}function estimateRouteFactory($http){return{get:function(id){return $http.post(ERPApp.baseAPIPath,{_do:"getEstimateRoute",data:{id:id}})},filter:function(query){return $http.get(ERPApp.baseAPIPath,{params:query})},all:function(){return $http.get(ERPApp.baseAPIPath,{params:{_do:"getEstimateRoutes"}})},save:function(data){return $http.post(ERPApp.baseAPIPath,{_do:"saveEstimateRoute",data:data})},update:function(data){return $http.post(ERPApp.baseAPIPath,{_do:"updateEstimateRoute",data:data})},updateStatus:function(data){return $http.post(ERPApp.baseAPIPath,{_do:"updateEstimateRouteStatus",data:data})},recent:function(){return $http.get(ERPApp.baseAPIPath,{params:{_do:"getRecentEstimateRoutes"}})}}}function formEstimateRoute(APP_CONFIG,erpLocalStorage,erpOptions){return{restrict:"E",templateUrl:APP_CONFIG.templatesPath+"estimate-route/form.html",controller:["$scope",function($scope){$scope.employees=[],$scope.routeStatuses=erpOptions.routeStatuses,erpLocalStorage.getEmployees().then(function(data){$scope.employees=data})}]}}function AppConfigCtrl($scope,$rootScope,$window,settingsFactory){$scope.config={},$scope.step=1,settingsFactory.getAppConfig().success(function(response){$scope.config=response}),$scope.submitForm=function(){settingsFactory.saveAppConfig($scope.config).success(function(response){response.success?$scope.step=2:toastr.error("An error occurred while saving the configuration")}).error(function(){toastr.error("An error occurred while saving the configuration")})},$scope.backToSetConsumerKeys=function(){$scope.step=1}}function SettingsCtrl($scope,settingsFactory){$scope.setPageTitle("Settings"),$scope.setting={},settingsFactory.get().success(function(response){$scope.setting=response}),$scope.submitForm=function(){settingsFactory.save($scope.setting).success(function(response){response.success?toastr.success(response.message):toastr.error(response.message)})},$scope.sendTestEmail=function(){var to=prompt("Please enter email to receive:");to&&to.trim().length>0&&settingsFactory.sendTestEmail(to,$scope.setting).success(function(response){response.success?toastr.success(response.message):toastr.error(response.message)}).error(function(data,status,header,config){408==status?toastr.warning("Timeout waiting for response!"):toastr.error("An error has occurred while sending email")})}}function settingsFactory($http){return{sendTestEmail:function(to,setting){return $http.post(ERPApp.baseAPIPath,{_do:"sendTestEmail",data:{to:to,setting:setting}},{timeout:1e4})},save:function(setting){return $http.post(ERPApp.baseAPIPath,{_do:"updateSetting",data:setting})},saveAppConfig:function(config){return $http.post(ERPApp.baseAPIPath,{_do:"saveAppConfig",data:config})},getAppConfig:function(config){return $http.get(ERPApp.baseAPIPath,{params:{_do:"getAppConfig"}})},get:function(){return $http.get(ERPApp.baseAPIPath,{params:{_do:"getSetting"}})},startSync:function(){return $http.post(ERPApp.baseAPIPath,{_do:"syncAll"},{timeout:5e4})}}}var ERPApp=ERPApp||{};toastr.options={closeButton:!0,debug:!1,positionClass:"toast-bottom-right",timeOut:"7000"},angular.module("Erp",["ngRoute","selectize","ngSanitize","ngAnimate","as.sortable","ngDropzone","uiGmapgoogle-maps","ngBootbox","ui.bootstrap","ngMessages","yaru22.angular-timeago","ui.tree"]).run(["$rootScope","dataFactory","sharedData","$location","userPermission",function($rootScope,dataFactory,sharedData,$location,userPermission){$rootScope.pageTitle=ERPApp.pluginName,$rootScope.isBusy=!0,$rootScope.baseAPIPath=ERPApp.baseAPIPath,$rootScope.baseERPPluginUrl=ERPApp.baseERPPluginUrl,$rootScope.templatesPath=ERPApp.templatesPath,$rootScope.pluginName=ERPApp.pluginName,$rootScope.setPageTitle=function(title){$rootScope.pageTitle=title,angular.element("title").text($rootScope.pluginName+" - "+title)},$rootScope.loadingOn=function(){$rootScope.isBusy=!0},$rootScope.loadingOff=function(){$rootScope.isBusy=!1},$rootScope.hasCap=function(cap){return userPermission.hasCap(cap)},$rootScope.$on("notAuthorized",function(){$location.path("/not-authorized")}),$rootScope.$on("notFound",function(){$location.path("/not-found")}),$rootScope.$on("$routeChangeSuccess",function(event,current,prev){var currentHash=$location.path().replace(/^\//,"#");"#"==currentHash&&(currentHash="#/"),angular.element("li."+ERPApp.navigationClass+" a").each(function(){var el=angular.element(this);this.hash===currentHash?el.parent("li").addClass("current"):el.parent("li").removeClass("current")})}),$rootScope.$on("$routeChangeStart",function(event,current,prev){var requestPath=$location.path();""===requestPath&&(requestPath="/"),userPermission.canAccessTo(requestPath)||(event.preventDefault(),$rootScope.$broadcast("notAuthorized"))})}]),angular.module("Erp").config(["$httpProvider","uiGmapGoogleMapApiProvider",function($httpProvider,uiGmapGoogleMapApiProvider){$httpProvider.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8",$httpProvider.interceptors.push("erpHttpInterceptor"),uiGmapGoogleMapApiProvider.configure({key:"",v:"3.17",libraries:"geometry, visualization"})}]);var initInjector=angular.injector(["ng"]),$http=initInjector.get("$http");$http.get(ERPApp.baseAPIPath,{params:{_do:"getSharedData"}}).then(function(response){angular.module("Erp").constant("USER_CAPABILITIES",response.data.userData.capabilities).constant("USER_ROLES",response.data.userData.roles).constant("APP_CONFIG",{baseAPIPath:ERPApp.baseAPIPath,basePluginPath:ERPApp.baseERPPluginUrl,pluginName:ERPApp.pluginName,templatesPath:ERPApp.templatesPath}).value("sharedData",{companyInfo:response.data.companyInfo,currentUserName:response.data.userData.name,lastSyncAt:response.data.lastSyncAt}),angular.element(document).ready(function(){angular.bootstrap(document,["Erp"])})},function(){toastr.error("An error has occurred, could not start the app!")}),angular.module("Erp").config(["$routeProvider","$locationProvider",function($routeProvider,$locationProvider){$routeProvider.when("/",{templateUrl:ERPApp.templatesPath+"dashboard.html"}).when("/new-job-request",{templateUrl:ERPApp.templatesPath+"job-request/add.html"}).when("/edit-job-request/:id",{templateUrl:ERPApp.templatesPath+"job-request/edit.html"}).when("/job-requests",{templateUrl:ERPApp.templatesPath+"job-request/list.html"}).when("/estimate-routes",{templateUrl:ERPApp.templatesPath+"estimate-route/list.html"}).when("/new-estimate-route",{templateUrl:ERPApp.templatesPath+"estimate-route/add.html"}).when("/edit-estimate-route/:id",{templateUrl:ERPApp.templatesPath+"estimate-route/edit.html"}).when("/new-estimate",{templateUrl:ERPApp.templatesPath+"estimate/add.html"}).when("/edit-estimate/:id",{templateUrl:ERPApp.templatesPath+"estimate/edit.html"}).when("/estimates",{templateUrl:ERPApp.templatesPath+"estimate/list.html"}).when("/estimates/page/:pageNumber",{templateUrl:ERPApp.templatesPath+"estimate/list.html"}).when("/crew-routes",{templateUrl:ERPApp.templatesPath+"crew-route/list.html"}).when("/new-crew-route",{templateUrl:ERPApp.templatesPath+"crew-route/add.html"}).when("/edit-crew-route/:id",{templateUrl:ERPApp.templatesPath+"crew-route/edit.html"}).when("/crew-route/:id/work-order",{templateUrl:ERPApp.templatesPath+"crew-route/work-order.html"}).when("/settings",{templateUrl:ERPApp.templatesPath+"settings.html"}).when("/company-info",{templateUrl:ERPApp.templatesPath+"company-info.html"}).when("/quickbooks-sync",{templateUrl:ERPApp.templatesPath+"quickbooks-sync.html"}).when("/not-authorized",{templateUrl:ERPApp.templatesPath+"not-authorized.html"}).when("/not-found",{templateUrl:ERPApp.templatesPath+"not-found.html"}).otherwise({templateUrl:ERPApp.templatesPath+"not-found.html"})}]),angular.module("Erp").directive("autofocus",["$timeout",function($timeout){return{restrict:"A",link:function($scope,$element){$timeout(function(){$element[0].focus()})}}}]),angular.module("Erp").directive("classesSelect",[classesSelect]),angular.module("Erp").directive("customerSignatureModal",["$rootScope","$timeout",customerSignatureModal]),angular.module("Erp").directive("customerTypeahead",[customerTypeahead]),angular.module("Erp").directive("customersSelect",function(){return{restrict:"E",scope:{ngModel:"=",selectOptions:"=options",ngDisabled:"=",ngRequired:"&",ngChange:"=",onCustomerUpdate:"&",onCustomerChange:"&",onCustomerCreated:"&"},template:'<selectize ng-model="ngModel" ng-change="onCustomerChangeEvent()" config="selectConfig" options="selectOptions"></selectize> <small ng-if="addingEnabled"><a href="#" ng-click="$event.preventDefault(); onAddCustomer()"><span class="glyphicon glyphicon-plus"></span> New customer</a></small> <small ng-if="editingEnabled && ngModel"><span>|</span> <a href="#" ng-click="$event.preventDefault(); onEditCustomer()"><span class="glyphicon glyphicon-info-sign"></span> Customer details</a></small>',controller:["$scope","$attrs","$uibModal","APP_CONFIG","erpLocalStorage","$timeout",function($scope,$attrs,$uibModal,APP_CONFIG,erpLocalStorage,$timeout){$scope.addingEnabled=$scope.editingEnabled=!1,$scope.onCustomerChangeEvent=function(){$timeout(function(){$scope.onCustomerChange()})},"undefined"==typeof $attrs.addEnabled?$scope.addingEnabled=!0:$scope.addingEnabled="true"==$attrs.addEnabled,"undefined"==typeof $attrs.editEnabled?$scope.editingEnabled=!0:$scope.editingEnabled="true"==$attrs.editEnabled;var selectConfig={valueField:"id",labelField:"display_name",searchField:"display_name",sortField:"order",selectOnTab:!0,maxItems:1,maxOptions:500};$scope.addingEnabled?selectConfig.create=function(input,callback){$scope.onAddCustomer(input),callback()}:selectConfig.create=!1,selectConfig.render={option:function(item,escape){var itemClass="option ",itemText=item.display_name;return null!==item.parent_id&&"undefined"!=typeof item.parent_display_name&&"0"!==item.parent_id&&(itemClass+="sub ",itemClass+="sub-level-"+item.sub_level,itemText+="<small> Sub-customer of <b>"+item.parent_display_name+"</b></small>"),'<div class="'+itemClass+'">'+itemText+"</div>"}},$scope.selectConfig=selectConfig;var getDefaultModalOpts=function(){return{animation:!0,backdrop:!0,keyboard:!1,templateUrl:APP_CONFIG.templatesPath+"customer/modal.html",controller:"customerModalCtrl",size:"lg"}};$scope.onEditCustomer=function(){var modalOpts=getDefaultModalOpts();modalOpts.resolve={customerData:function(){return{id:$scope.ngModel}}};var modalInstance=$uibModal.open(modalOpts);modalInstance.result.then(function(returnData){erpLocalStorage.updateCustomer(returnData.customer),erpLocalStorage.getCustomers().then(function(data){$scope.selectOptions=[],angular.copy(data,$scope.selectOptions)}),returnData.updateFormFlag&&$scope.onCustomerUpdate()},function(){})},$scope.onAddCustomer=function(input){"undefined"==typeof input&&(input="");var modalOpts=getDefaultModalOpts();modalOpts.resolve={customerData:function(){return{name:input}}};var modalInstance=$uibModal.open(modalOpts);modalInstance.result.then(function(returnData){erpLocalStorage.addCustomer(returnData.customer),erpLocalStorage.getCustomers().then(function(data){$scope.selectOptions=[],angular.copy(data,$scope.selectOptions)}),$scope.onCustomerCreated(),$scope.ngModel=returnData.customer.id,$timeout(function(){returnData.updateFormFlag&&$scope.onCustomerChange()},100)},function(){})}}]}}),angular.module("Erp").directive("employeesSelect",[estimatorsSelect]),angular.module("Erp").directive("erpPagination",function(){return{template:'<uib-pagination ng-show="total"rotate="true"boundary-links="true"max-size="10" class="pagination-md"total-items="total"items-per-page="30"ng-model="currentPage"ng-change="pageChanged()"></uib-pagination>'}}),angular.module("Erp").directive("multipleEmails",function(){return{require:"ngModel",link:function(scope,element,attrs,ctrl){ctrl.$parsers.unshift(function(viewValue){if(ctrl.$isEmpty(viewValue))return ctrl.$setValidity("multipleEmails",!0),"";var emails=viewValue.split(","),re=/\S+@\S+\.\S+/,validityArr=emails.map(function(str){return re.test(str.trim())}),atLeastOneInvalid=!1;return angular.forEach(validityArr,function(value){value===!1&&(atLeastOneInvalid=!0)}),atLeastOneInvalid?(ctrl.$setValidity("multipleEmails",!1),""):(ctrl.$setValidity("multipleEmails",!0),viewValue)})}}}),angular.module("Erp").directive("requiredFile",function(){return{require:"ngModel",link:function(scope,el,attrs,ngModel){el.bind("change",function(){scope.$apply(function(){ngModel.$setViewValue(el.val()),ngModel.$render()})})}}}),angular.module("Erp").directive("textTruncate",[textTruncate]),angular.module("Erp").factory("classFactory",["$http",classFactory]),angular.module("Erp").factory("dataFactory",["$http",dataFactory]),angular.module("Erp").factory("erpHttpInterceptor",["$q","$rootScope","$injector",function($q,$rootScope,$injector){return $rootScope.http=null,{request:function(config){return $rootScope.loadingOn(),!config.data||"object"!=typeof config.data||config.data instanceof FormData||(config.data=jQuery.param(config.data)),config||$q.when(config)},requestError:function(rejection){return $rootScope.http=$rootScope.http||$injector.get("$http"),$rootScope.http.pendingRequests.length<1&&$rootScope.loadingOff(),$q.reject(rejection)},response:function(response){return $rootScope.http=$rootScope.http||$injector.get("$http"),$rootScope.http.pendingRequests.length<1&&$rootScope.loadingOff(),response||$q.when(response)},responseError:function(rejection){return $rootScope.http=$rootScope.http||$injector.get("$http"),$rootScope.http.pendingRequests.length<1&&$rootScope.loadingOff(),404==rejection.status&&$rootScope.$broadcast("notFound"),$q.reject(rejection)}}}]),angular.module("Erp").service("erpLocalStorage",["$q","sharedData","employeeFactory","customerFactory","productServiceFactory","classFactory",erpLocalStorage]),angular.module("Erp").value("erpOptions",{sortCrewRoute:[{label:"Custom",value:""},{label:"Total",value:"total"},{label:"Exp date",value:"expiration_date"}],sortEstimateRoute:[{label:"Custom",value:""},{label:"Status",value:"status"},{label:"Date Requested",value:"date_requested"}],referralStatuses:[{value:"Pending",label:"Pending"},{value:"Assigned",label:"Assigned"},{value:"Completed",label:"Completed"}],routeStatuses:[{value:"Pending",label:"Pending"},{value:"Assigned",label:"Assigned"},{value:"Completed",label:"Completed"}],estimateStatuses:[{value:"Pending",label:"Pending"},{value:"Accepted",label:"Accepted"},{value:"Completed",label:"Completed/WFI"},{value:"Routed",label:"Routed"},{value:"Closed",label:"Closed"},{value:"Rejected",label:"Rejected"}],map:{firstPointColor:"#52BC2B",middlePointColor:"#3F51B5",lastPointColor:"#9A0C02",markerLabels:"ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789",polylineOptions:{strokeColor:"#353BE1",strokeOpacity:.7,strokeWeight:5}}}),angular.module("Erp").service("erpGeoLocation",["$q",erpGeoLocation]),angular.module("Erp").service("userPermission",["USER_CAPABILITIES",userPermission]),angular.module("Erp").filter("estimateJobFullAddress",function(){return function(estimate){var fullAddress="",streetCity=[estimate.job_address,estimate.job_city].join(" ").trim(),stateZip=[estimate.job_state,estimate.job_zip_code].join(" ").trim();return streetCity.length>0&&(fullAddress=streetCity),fullAddress.length>0&&stateZip.length>0?fullAddress+=", "+stateZip:fullAddress=streetCity,fullAddress}}),angular.module("Erp").filter("referralFullAddress",function(){return function(referral){var fullAddress="",streetCity=[referral.address,referral.city].join(" ").trim(),stateZip=[referral.state,referral.zip_code].join(" ").trim();return streetCity.length>0&&(fullAddress=streetCity),fullAddress.length>0&&stateZip.length>0?fullAddress+=", "+stateZip:fullAddress=streetCity,fullAddress}}),angular.module("Erp").controller("CompanyInfoCtrl",["$scope","$rootScope","companyInfoFactory","sharedData",CompanyInfoCtrl]),angular.module("Erp").factory("companyInfoFactory",["$http",companyInfoFactory]),angular.module("Erp").factory("customerFactory",["$http",customerFactory]),
angular.module("Erp").controller("customerModalCtrl",function($scope,$rootScope,$uibModalInstance,customerFactory,erpLocalStorage,customerData){$scope.updateFormFlag=!0,$scope.customer={},$scope.customers=[],erpLocalStorage.getCustomers().then(function(data){$scope.customers=[],angular.copy(data,$scope.customers)});var customerId=customerData.id;if("undefined"!=typeof customerId)customerFactory.show(customerId).success(function(customerInfo){$scope.customer=customerInfo});else{var customerName=customerData.name.trim();if(customerName.length>0){var spacePos=customerName.indexOf(" ");-1!==spacePos?($scope.customer.given_name=customerName.substr(0,spacePos).trim(),$scope.customer.family_name=customerName.substr(spacePos+1).trim()):$scope.customer.given_name=customerName}}$scope.validateForm=function(){return $scope.customerForm.$valid},$scope.fillDisplayName=function(){if(!$scope.customerForm.display_name.$dirty&&!$scope.customer.id){var displayName="";$scope.customer.family_name&&(displayName=$scope.customer.family_name),$scope.customer.given_name&&displayName?displayName+=", "+$scope.customer.given_name:$scope.customer.given_name&&(displayName=$scope.customer.given_name),$scope.customer.display_name=displayName.trim()}},$scope.save=function(){$scope.validateForm()&&customerFactory.create($scope.customer).success(function(response){response.success&&(toastr.success(response.message),$uibModalInstance.close({customer:response.customer,updateFormFlag:$scope.updateFormFlag}))}).error(function(){toastr.error("An error occurred while saving customer")})},$scope.close=function(){$uibModalInstance.dismiss()}}),angular.module("Erp").factory("employeeFactory",["$http",employeeFactory]),angular.module("Erp").controller("AddEstimateCtrl",["$scope","$rootScope","$http","$timeout","$routeParams","$filter","$location","estimateFactory","jobRequestFactory","erpGeoLocation","$ngBootbox","sharedData","erpLocalStorage","erpOptions",AddEstimateCtrl]),angular.module("Erp").controller("EditEstimateCtrl",["$scope","$rootScope","$http","$routeParams","$filter","$location","estimateFactory","erpLocalStorage","erpGeoLocation","attachmentUploader","sharedData","erpOptions","$ngBootbox","$window",EditEstimateCtrl]),angular.module("Erp").controller("ListEstimateCtrl",["$scope","$rootScope","$routeParams","$location","$timeout","estimateFactory","sharedData","erpLocalStorage","erpGeoLocation",ListEstimateCtrl]),angular.module("Erp").factory("attachmentUploader",["$http",attachmentUploader]),angular.module("Erp").factory("estimateFactory",["$http",estimateFactory]),angular.module("Erp").controller("AddCrewRouteCtrl",["$scope","$rootScope","estimateFactory","crewRouteFactory","$location","uiGmapGoogleMapApi","uiGmapIsReady","$filter","erpOptions","sharedData","erpGeoLocation",AddCrewRouteCtrl]),angular.module("Erp").controller("EditCrewRouteCtrl",["$scope","$rootScope","estimateFactory","crewRouteFactory","$location","$routeParams","uiGmapGoogleMapApi","uiGmapIsReady","$filter","erpOptions","sharedData","erpGeoLocation",EditCrewRouteCtrl]),angular.module("Erp").controller("ListCrewRouteCtrl",["$scope","$rootScope","$routeParams","crewRouteFactory","erpOptions","$ngBootbox",ListCrewRouteCtrl]),angular.module("Erp").controller("WorkOrderCtrl",["$scope","$rootScope","$routeParams","crewRouteFactory","estimateFactory",WorkOrderCtrl]),angular.module("Erp").factory("crewRouteFactory",["$http",crewRouteFactory]),angular.module("Erp").directive("formCrewRoute",["APP_CONFIG","erpOptions",formCrewRoute]),angular.module("Erp").factory("productServiceFactory",["$http",productServiceFactory]),angular.module("Erp").controller("QuickbooksSyncCtrl",["$scope","$window","quickbooksSyncFactory","erpLocalStorage","$ngBootbox",QuickbooksSyncCtrl]),angular.module("Erp").factory("quickbooksSyncFactory",["$http",quickbooksSyncFactory]),angular.module("Erp").controller("AddJobRequestCtrl",["$scope","$rootScope","jobRequestFactory","erpLocalStorage","sharedData","$location","$filter","$uibModal","erpGeoLocation",AddJobRequestCtrl]),angular.module("Erp").controller("EditJobRequestCtrl",["$scope","$rootScope","jobRequestFactory","erpLocalStorage","sharedData","$routeParams","$filter","$window","erpGeoLocation",EditJobRequestCtrl]),angular.module("Erp").controller("ListJobRequestCtrl",["$scope","$routeParams","jobRequestFactory","estimateRouteFactory","erpLocalStorage","erpGeoLocation","erpOptions","$ngBootbox","$timeout",ListJobRequestCtrl]),angular.module("Erp").factory("jobRequestFactory",["$http",jobRequestFactory]),angular.module("Erp").controller("AddEstimateRouteCtrl",["$scope","$rootScope","jobRequestFactory","estimateRouteFactory","sharedData","$location","$filter","erpOptions","uiGmapGoogleMapApi","uiGmapIsReady","erpGeoLocation",AddEstimateRouteCtrl]),angular.module("Erp").controller("EditEstimateRouteCtrl",["$scope","$rootScope","jobRequestFactory","estimateRouteFactory","erpLocalStorage","sharedData","$routeParams","uiGmapGoogleMapApi","uiGmapIsReady","$filter","erpOptions","erpGeoLocation",EditEstimateRouteCtrl]),angular.module("Erp").controller("ListEstimateRouteCtrl",["$scope","$rootScope","$routeParams","estimateRouteFactory","erpOptions","$ngBootbox",ListEstimateRouteCtrl]),angular.module("Erp").directive("assignedRequestsTable",function($rootScope){return{restrict:"E",templateUrl:$rootScope.templatesPath+"estimate-route/assigned-requests-table.html"}}),angular.module("Erp").factory("estimateRouteFactory",["$http",estimateRouteFactory]),angular.module("Erp").directive("formEstimateRoute",["APP_CONFIG","erpLocalStorage","erpOptions",formEstimateRoute]),angular.module("Erp").controller("AppConfigCtrl",["$scope","$rootScope","$window","settingsFactory",AppConfigCtrl]),angular.module("Erp").controller("SettingsCtrl",["$scope","settingsFactory",SettingsCtrl]),angular.module("Erp").factory("settingsFactory",["$http",settingsFactory]);